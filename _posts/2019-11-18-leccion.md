---
layout: post
title:  "Clase del Lunes 18/11/2019"
categories: Web
---

# Clase del Lunes 18/11/2019


## Chapter 20 of Eloquent JS

* [https://ull-mii-sytws-1920.github.io/tema1-introduccion/practicas/p3-t1-c3-http/]({{site.baseurl}}/tema1-introduccion/practicas/p3-t1-c3-http/)

#### Using Promises with node-fetch in the client

Making requests with Node’s raw functionality is rather verbose. There are much more convenient wrapper packages available on NPM. For example, [node-fetch](https://www.npmjs.com/package/node-fetch) provides the promise-based fetch interface that is used in the browser.

```
~/.../chapter20-node-js-crguezl/the-http-module(master)]$ pwd -P
/Users/casiano/local/src/javascript/eloquent-javascript/chapter20-node-js/chapter20-node-js-crguezl/the-http-module
~/.../chapter20-node-js-crguezl/the-http-module(master)]$ cat simple-client-promise.js 
```

```js
const portNumber = 8000;
const ip = require("ip");
const fetch = require('node-fetch');

const hostname = ip.address(), 
      port = portNumber,
      path = "/20_node.html";

const options = {     
    method: "DELETE",
    headers: {Accept: "text/html"}
  };

fetch(`http://${hostname}:${port}/${path}`, options)
    .then(r => { // r is a Response object which is a stream
        let p = r.text();
        console.log(p); // Promise { <pending> }
        return p;
    })
    .then( (r) => console.log(r))
    .catch( e => console.log("Hubieron errores:\n"+e));
```

Ejecución contra el [server sencillo descrito en la lección del 11/11/2019](https://ull-mii-sytws-1920.github.io/web/2019/11/11/leccion.html#simple-server):

```
[~/.../chapter20-node-js-crguezl/the-http-module(master)]$ node simple-client-promise.js 
Promise { <pending> }

<h1>Hello!</h1>
<p>You asked for 
<code>
//20_node.html 
<!-- The url is the full URL without the server, protocol or port. -->
</code>
using the DELETE method
</p>
<p>Your headers:</p> 
<pre>
{
  accept: 'text/html',
  'user-agent': 'node-fetch/1.0 (+https://github.com/bitinn/node-fetch)',
  'accept-encoding': 'gzip,deflate',
  connection: 'close',
  host: '10.150.22.51:8000'
}
</pre>
```

#### Rewriting the client with async-await

```
[~/.../chapter20-node-js-crguezl/the-http-module(master)]$ pwd -P
/Users/casiano/local/src/javascript/eloquent-javascript/chapter20-node-js/chapter20-node-js-crguezl/the-http-module
[~/.../chapter20-node-js-crguezl/the-http-module(master)]$ cat simple-client-await.js 
```


```js
const portNumber = 8000;
const ip = require("ip");
const fetch = require('node-fetch');

const hostname = ip.address(), 
      port = portNumber,
      path = "/20_node.html";

const options = {     
    method: "DELETE",
    headers: {Accept: "text/html"}
  };

(async () => {
    try {
        let r = await fetch(`http://${hostname}:${port}/${path}`, options);
        let t = await r.text();
        console.log(t);    
      }
      catch (e) {
          console.log("Hubieron errores:\n"+e);
      }
})()
```

People who are just starting to use `await` tend to forget the fact that we can’t use `await` in top-level code.
The solution is to wrap it into an anonymous async function.

```js
(async () => {
  let response = await fetch('/article/promise-chaining/user.json');
  let user = await response.json();
  ...
})();
```

### La práctica p3-t1-c3-http: Exercises from Chapter 20 of EJS

Para ver una solución a la práctica [repase la sección *soluciones a la Práctica de la clase del 11/11/2019](https://ull-mii-sytws-1920.github.io/web/2019/11/11/leccion.html#soluciones-a-la-pr%C3%A1ctica).

```
[~/.../chapter20-nodejs/juanIrache-20_3_public_space(master)]$ pwd -P
/Users/casiano/local/src/javascript/eloquent-javascript-3/juanIrache-solutions/20_3_public_space
```
Quote from the [EJS book hints for this exercise](https://eloquentjavascript.net/20_node.html#i_h8iNiA8ezX):

> You can use the function that implements the `DELETE` method as a blueprint for the `MKCOL` method. When no file is found, try to create a directory with `mkdir`. When a directory exists at that path, you can return a `204` response **so that directory creation requests are <u>idempotent</u>**. If a nondirectory file exists here, return an error code. Code `400` (`bad request`) would be appropriate.

```js
const {mkdir} = require("fs").promises;

methods.MKCOL = async function(request) {
  let path = urlPath(request.url);
  let stats;
  try {
    stats = await stat(path);
  } catch (error) {
    if (error.code != "ENOENT") throw error;
    await mkdir(path);
    return {status: 204};
  }
  if (stats.isDirectory()) return {status: 204};
  else return {status: 400, body: "Not a directory"};
};
```

#### Idempotent REST APIs

* [Idempotent REST APIs](https://restfulapi.net/idempotent-rest-apis)

**HTTP POST**

Generally – not necessarily – `POST` APIs are used to **create** a new resource on server. So when you invoke the same POST request N times, you will have N new resources on the server. So, _`POST` is not idempotent_.

**HTTP PUT**

Generally – not necessarily – `PUT` APIs are used to **update** the resource state. If you invoke a `PUT` API N times, the very first request will update the resource; then rest N-1 requests will just overwrite the same resource state again and again – effectively not changing anything. Hence, _`PUT` is idempotent_.

**HTTP DELETE**

When you invoke N similar `DELETE` requests, first request will delete the resource and response will be `200` (OK) or `204` (No Content). Other N-1 requests will return `404` (Not Found). Clearly, the response is different from first request, **but there is no change of state for any resource** on server side because original resource is already deleted. So, _`DELETE` is idempotent_.

Please keep in mind if some systems may have `DELETE` APIs like this:

**DELETE /item/last**

In the above case, calling operation N times will delete N resources – hence `DELETE` is not idempotent in this case. In this case, a good suggestion might be to change above API to `POST` – because `POST` is not idempotent.

**POST /item/last**

Now, this is closer to HTTP spec – hence more REST compliant.

#### STATUS

* [204](https://httpstatuses.com/204)

### [Gulp]({{site.baseurl}}/tema1-introduccion/build-tools)

## Resources and References for this Lesson

* [This class in GitHub pages]({{site.baseurl}}/clases/2019-11-04/)
* [See this repo with the solutions by Juan Irache to EJS exercises]({{site.github_org}}/eloquent-javascript-exercises)
  - [20_3_a_public_space]({{site.github_org}}/eloquent-javascript-exercises/tree/master/20_3_public_space)
* See section [of the EJS book: The HTTP module](https://eloquentjavascript.net/20_node.html#the-http-module)
* [Node.js docs: Anatomy of an HTTP Transaction](https://nodejs.org/es/docs/guides/anatomy-of-an-http-transaction/)

## Chapter 3: Networking with Sockets

* [Apuntes del tema Sockets]({{site.baseurl}}/tema2-async/sockets)
* [Material suplementario]({{site.github_org}}/books-shared)
* [Descripción de la práctica tema2-async/practicas/p4-t2-networking/]({{site.baseurl}}/tema2-async/practicas/p4-t2-networking/)
* [GitHub Actions]({{site.baseurl}}/tema4-devops/github-actions)
* [Repo de ejemplo con una solución y GitHub Actions p4-t2-networking-crguezl]({{site.github_org}}/p4-t2-networking-crguezl)

   ```
    [~/.../github-actions-learning/p4-t2-net-github-actions-crguezl(master)]$ pwd -P
    /Users/casiano/local/src/github-actions-learning/p4-t2-net-github-actions-crguezl
   ```

