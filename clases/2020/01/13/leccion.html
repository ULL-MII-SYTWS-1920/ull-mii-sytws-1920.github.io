<!doctype html>
<html lang=" en-US ">

<head>
    <meta charset="utf-8">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=a8db9f5ed3bfce1c7849f44f99b16371e6a97696">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="/assets/js/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="/assets/css/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

</head>

<body>
    <div id="header">
        <nav>
    <li><a href="/search" title="search">&#x1F50D;</a></li>
    <!--
    <li><a href="#sytwstoc" title="Table of Contents">‚â°</a></li>
    -->

    
    
    <li><a href="/clases/2020/10/05/leccion.html" title="Next">&#x2192;</a></li>
    
    <li><a href="https://github.com/ULL-MII-SYTWS-1920/ull-mii-sytws-1920.github.io/tree/master//_posts/2020-01-13-leccion.md" title="Edit this page at GitHub">üêô</a>
    
    <li><a href="/references.html" title="Bibliograf√≠a">&#x1f4da</a></li>
    <li><a href="/practicas.html" title="Pr√°cticas">&#x270d</a></li>
    
    <li><a href="/clases.html" title="Clases">üë®‚Äçüè´</a></li>

    <li><a href="/" title="Home page">&#x1f3e0</a></li>
    <li><a href="/tema0-presentacion/" title="Tema 0: Presentaci√≥n">0</a></li>
    <li><a href="/tema1-introduccion/" title="Tema 1: Introducci√≥n">1</a></li>
    <li><a href="/tema2-async/" title="Tema 2: Async">2</a></li>
    <li><a href="/tema3-web/" title="Tema 3: Web">3</a></li>
    <li><a href="/tema4-devops/" title="Tema 4: Devop">4</a></li>
    
</nav>

    </div>
    <!-- end header -->


    <div class="wrapper">

        <section>
            
<div id="title">
        <h1>Sistemas y Tecnolog√≠as Web: Servidor</h1>
        <p> Master de II. ULL. 1er cuatrimestre. 2020/2021</p>
        <hr>
        <span class="credits left">Organization <a href="https://github.com/ULL-MII-SYTWS-2021" target="_blank">ULL-MII-SYTWS-2021</a></span>
        <span class="credits left"> &nbsp; Classroom <a href="https://classroom.github.com/classrooms/68184806-ull-mii-sytws-2021" target="_blank">ULL-MII-SYTWS-2021</a></span>
        <span class="credits left"> &nbsp; Campus Virtual <a href="https://campusdoctoradoyposgrado.ull.es/course/view.php?id=2020111300" target="_blank">SYTWS</a></span>
        <span class="credits left"> &nbsp; Chat <a href="https://chat.google.com/u/1/room/AAAAp18fCE8" target="_blank">Chat</a></span>
        <span class="credits left"> &nbsp; Profesor <a href="https://www.ull.es/apps/guias/guias/view_teacher_niu/745/(%3FPcrguezl.*)/" target="_blank">Casiano</a></span>
    </div>

<!--

<div id="title">
    <h1>Sistemas y Tecnolog√≠as Web: Servidor</h1>
    <p> Master de II. ULL. 1er cuatrimestre. 2020/2021</p>
    <hr>
    <span class="credits left">Organization <a href="https://github.com/ULL-MII-SYTWS"
            target="_blank">ULL-MII-SYTWS</a></span>
    <span class="credits left"> &nbsp; Github Classroom <a
            href="https://classroom.github.com/classrooms/55384072-master-de-ingenieria-informatica-sistemas-y-tecnologias-web-servidor-classroom"
            target="_blank">SYTWS 19/20</a></span>
    <span class="credits left"> &nbsp; Campus Virtual <a
            href="https://campusvirtual.ull.es/1920/course/view.php?id=201913778" target="_blank">SYTWS
            19/20</a></span>
    <span class="credits left"> &nbsp; Profesor <a
            href="https://www.ull.es/apps/guias/guias/view_teacher_niu/588/(%3FPcrguezl.*)/"" target="
            _blank">Casiano</a></span>
</div>
-->    

            
            



            <h2 >Table of Contents</h2>
            
            <ul id="sytwstoc">
  <li><a href="#clase-del-lunes-13012020">Clase del Lunes 13/01/2020</a>
    <ul>
      <li><a href="#final-de-curso">Final de Curso</a></li>
      <li><a href="#descripci√≥n-de-la-pr√°ctica-developing-restful-web-services">Descripci√≥n de la Pr√°ctica <em>Developing RESTful Web Services</em></a></li>
      <li><a href="#advantages-of-express">Advantages of Express</a></li>
      <li><a href="#serving-apis-with-express">Serving APIs with Express</a></li>
      <li><a href="#our-goal-in-this-chapter-writing-modular-express-services">Our Goal in this Chapter: Writing Modular Express Services</a></li>
      <li><a href="#how-nconf-manages-configuration-settings">How <strong>nconf</strong> manages configuration settings</a></li>
      <li><a href="#keeping-services-running-with-nodemon">Keeping Services Running with nodemon</a>
        <ul>
          <li><a href="#separating-server-code-into-modules">Separating Server Code into Modules</a></li>
        </ul>
      </li>
      <li><a href="#adding-search-apis">Adding Search APIs</a>
        <ul>
          <li><a href="#using-requests-with-express">Using Requests with Express</a></li>
        </ul>
      </li>
      <li><a href="#simplifying-code-flows-with-promises">Simplifying Code Flows with Promises</a>
        <ul>
          <li><a href="#fulfilling-promises">Fulfilling Promises</a></li>
          <li><a href="#using-a-promise-with-request">Using a Promise with Request</a>
            <ul>
              <li><a href="#example-of-request-to-the-elasticsearch-suggest-api-with-curl">Example of request to the Elasticsearch suggest API with <code class="language-plaintext highlighter-rouge">curl</code></a></li>
              <li><a href="#example-of-request-to-the-elasticsearch-suggest-api-with-postman">Example of request to the Elasticsearch suggest API with <code class="language-plaintext highlighter-rouge">postman</code></a></li>
              <li><a href="#code-for-the-route-apisuggestfieldquery">Code for the Route ‚Äò/api/suggest/:field/:query‚Äô</a></li>
            </ul>
          </li>
          <li><a href="#replacing-request-with-request-promise">Replacing request with request-promise</a></li>
        </ul>
      </li>
      <li><a href="#manipulating-documents-restfully">Manipulating Documents RESTfully</a></li>
      <li><a href="#emulating-synchronous-style-with-async-and-await">Emulating Synchronous Style with async and await</a></li>
      <li><a href="#providing-an-async-handler-function-to-express">Providing an Async Handler Function to Express</a>
        <ul>
          <li><a href="#setting-the-bundle-name-with-put">Setting the Bundle Name with PUT</a></li>
          <li><a href="#putting-a-book-into-a-bundle">Putting a Book into a Bundle</a></li>
        </ul>
      </li>
      <li><a href="#wrapping-up">Wrapping Up</a>
        <ul>
          <li><a href="#deleting-a-bundle-entirely">Deleting a Bundle Entirely</a></li>
          <li><a href="#removing-a-book-from-a-bundle">Removing a Book from a Bundle</a></li>
        </ul>
      </li>
      <li><a href="#peer-dependencies">Peer-dependencies</a></li>
      <li><a href="#gulpfile-tasks">Gulpfile tasks</a></li>
      <li><a href="#references">References</a></li>
    </ul>
  </li>
</ul>
          

            <div class="container">
                <h1 id="clase-del-lunes-13012020">Clase del Lunes 13/01/2020</h1>

<h2 id="final-de-curso">Final de Curso</h2>

<ul>
  <li><a href="https://drive.google.com/file/d/1EBVRMo7LwDQYdQ4-d7Pbzw84XQeqIa-C/view">Descripci√≥n del calendario</a></li>
  <li>Entiendo que las clases se acaban el 17/01/2019</li>
  <li>Los ex√°menes aparece del 20/01 al 01/02. Los de la Web ULL no han actualizado el enlace, pero es este:
    <ul>
      <li><a href="https://docs.google.com/document/d/1L1vcYHPtowuP_v-1HLMtJms7S_efD3jHt9H4zrND1IU/edit">Ex√°menes de la Convocatoria de Enero</a></li>
      <li>Enero:
        <ul>
          <li>24/1/2020</li>
          <li>16:00</li>
          <li>2.2</li>
          <li>31/1/2020</li>
          <li>16:00</li>
          <li>2.2</li>
        </ul>
      </li>
      <li>Junio
        <ul>
          <li>3/7/2020</li>
          <li>16:00</li>
          <li>2.2</li>
        </ul>
      </li>
      <li>Septiembre
        <ul>
          <li>4/9/2020</li>
          <li>16:00</li>
          <li>2.2</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Cierre de actas: Viernes 7 de Febrero de 2020</li>
  <li>Hemos a√±adido una pr√°ctica nueva y el Trabajo Fin de Asignatura
    <ul>
      <li><a href="/tema3-web/practicas/p11-t3-restful/">p11-t3-restful</a></li>
      <li><a href="/tema3-web/practicas/p12-tfa-user-experience/">p12-tfa-user-experience</a></li>
    </ul>
  </li>
  <li>Pueden encontrar las soluciones a las pr√°cticas del autor del libro en este repo <a href="https://github.com/ULL-MII-SYTWS-1920/book-solution-nodejs-the-right-way">ULL-MII-SYTWS-1920/book-solution-nodejs-the-right-way</a>. Deber√≠a tener permisos de acceso</li>
  <li>Para cada convocatoria, las pr√°cticas deber√≠an estar entregadas en su mayor√≠a 5 d√≠as antes antes de los cierres de actas, que son estos d√≠as:
    <ul>
      <li>Viernes 14 de Febrero 2020</li>
      <li>Viernes 27 de Marzo 2020</li>
      <li>Jueves 25 de Junio 2020</li>
      <li>Mi√©rcoles 22 de Julio 2020</li>
      <li>Jueves 25 de Septiembre 2020</li>
    </ul>
  </li>
</ul>

<style>
table, td, th {  
  border: 1px solid #ddd;
  text-align: left;
}

table {
  border-collapse: collapse;
  width: 60%;
}

th, td {
  padding: 1px;
}
</style>

<table>
  <tr>
    <td>
    <img alt="/assets/images/enero2020.png" src="/assets/images/enero2020.png" />
    </td>
    <td>
    <img src="/assets/images/instrucciones-calendario.png" />
    </td>
  </tr>
</table>

<h2 id="descripci√≥n-de-la-pr√°ctica-developing-restful-web-services">Descripci√≥n de la Pr√°ctica <em>Developing RESTful Web Services</em></h2>

<p><a href="/tema3-web/practicas/p11-t3-restful/developing-restful-web-services.html">Descripci√≥n de la Pr√°ctica p11-t3-restful</a></p>

<h2 id="advantages-of-express">Advantages of Express</h2>
<p>Express  is modeled after Ruby <a href="http://www.sinatrarb.com/">Sinatra http://www.sinatrarb.com/</a></p>

<p><strong>web-services/server.js</strong></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">http</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">text/plain</span><span class="dl">'</span><span class="p">});</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="dl">'</span><span class="s1">Hello World!</span><span class="se">\n</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">60700</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Server listening in port 60700</span><span class="dl">'</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>A typical web server would take care of lots of little jobs that this code doesn‚Äôt touch.</p>

<p>Here are some examples:</p>

<ul>
  <li>Routing based on URL paths</li>
  <li>Managing sessions via cookies</li>
  <li>Parsing incoming requests (such as form data or JSON)</li>
  <li>Rejecting malformed requests</li>
</ul>

<p>The <a href="http://expressjs.com/">Express http://expressjs.com/</a>framework helps with these and myriad other tasks.</p>

<h2 id="serving-apis-with-express">Serving APIs with Express</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>[~/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7(master)]$ npm i express morgan
+ morgan@1.9.1
+ express@4.16.4
added 48 packages from 35 contributors and audited 475 packages in 8.46s
found 0 vulnerabilities
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>[~/.../web-services/b4(master)]$ jq .dependencies ~/sol-nodejs-the-right-way/package.json
{
  "chai": "^4.2.0",
  "cheerio": "^1.0.0-rc.2",
  "commander": "^2.19.0",
  "express": "^4.16.4",
  "morgan": "^1.9.1",
  "nconf": "^0.10.0",
  "node-dir": "^0.1.17",
  "node-red": "^0.19.5",
  "nodemon": "^1.18.7",
  "request": "^2.88.0",
  "request-promise": "^4.2.2",
  "zeromq": "^5.0.0",
  "zerorpc": "^0.9.8"
}
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>Code of hello/server.js</strong></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">morgan</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">morgan</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">morgan</span><span class="p">(</span><span class="dl">'</span><span class="s1">dev</span><span class="dl">'</span><span class="p">));</span>

<span class="c1">// In addition to get(), Express has put(), post(), and delete()</span>
<span class="c1">// methods to register handlers for HTTP PUT, POST, and DELETE requests,</span>
<span class="c1">// respectively</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/hello/:name</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span><span class="na">hello</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">60701</span><span class="p">,</span> <span class="p">()</span><span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Listening on 60701</span><span class="dl">"</span><span class="p">));</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>Starting the Client</strong>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>gulp.task("c7-express-client", shell.task(
  `curl -s localhost:60701/hello/ivan | jq`
));
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>[~/local/src/CA/sol-nodejs-the-right-way/commanding-databases-chapter-6(master)]$ gulp c7-express-client
[12:33:33] Working directory changed to ~/local/src/CA/sol-nodejs-the-right-way
[12:33:33] Using gulpfile ~/local/src/CA/sol-nodejs-the-right-way/gulpfile.js
[12:33:33] Starting 'c7-express-client'...
{
  "hello": "ivan"
}
[12:33:33] Finished 'c7-express-client' after 51 ms
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="our-goal-in-this-chapter-writing-modular-express-services">Our Goal in this Chapter: Writing Modular Express Services</h2>

<p>We‚Äôre going to build a RESTful web service with Express for creating and managing book bundles. Here‚Äôs an example of a book bundle:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="err">‚Äã</span><span class="w"> 	</span><span class="p">{</span><span class="w">
</span><span class="err">‚Äã</span><span class="w"> 	  </span><span class="err">‚Äã</span><span class="s2">"name"</span><span class="err">‚Äã:</span><span class="w"> </span><span class="err">‚Äã</span><span class="s2">"light reading"</span><span class="err">‚Äã</span><span class="p">,</span><span class="w">
</span><span class="err">‚Äã</span><span class="w"> 	  </span><span class="err">‚Äã</span><span class="s2">"books"</span><span class="err">‚Äã:</span><span class="w"> </span><span class="p">[{</span><span class="w">
</span><span class="err">‚Äã</span><span class="w"> 	    </span><span class="err">‚Äã</span><span class="s2">"id"</span><span class="err">‚Äã:</span><span class="w"> </span><span class="err">‚Äã</span><span class="s2">"pg132"</span><span class="err">‚Äã</span><span class="p">,</span><span class="w">
</span><span class="err">‚Äã</span><span class="w"> 	    </span><span class="err">‚Äã</span><span class="s2">"title"</span><span class="err">‚Äã:</span><span class="w"> </span><span class="err">‚Äã</span><span class="s2">"The Art of War"</span><span class="err">‚Äã</span><span class="w">
</span><span class="err">‚Äã</span><span class="w"> 	  </span><span class="p">},{</span><span class="w">
</span><span class="err">‚Äã</span><span class="w"> 	    </span><span class="err">‚Äã</span><span class="s2">"id"</span><span class="err">‚Äã:</span><span class="w"> </span><span class="err">‚Äã</span><span class="s2">"pg2680"</span><span class="err">‚Äã</span><span class="p">,</span><span class="w">
</span><span class="err">‚Äã</span><span class="w"> 	    </span><span class="err">‚Äã</span><span class="s2">"title"</span><span class="err">‚Äã:</span><span class="w"> </span><span class="err">‚Äã</span><span class="s2">"Meditations"</span><span class="err">‚Äã</span><span class="p">,</span><span class="w">
</span><span class="err">‚Äã</span><span class="w"> 	  </span><span class="p">},{</span><span class="w">
</span><span class="err">‚Äã</span><span class="w"> 	    </span><span class="err">‚Äã</span><span class="s2">"id"</span><span class="err">‚Äã:</span><span class="w"> </span><span class="err">‚Äã</span><span class="s2">"pg6456"</span><span class="err">‚Äã</span><span class="p">,</span><span class="w">
</span><span class="err">‚Äã</span><span class="w"> 	    </span><span class="err">‚Äã</span><span class="s2">"title"</span><span class="err">‚Äã:</span><span class="w"> </span><span class="err">‚Äã</span><span class="s2">"Public Opinion"</span><span class="err">‚Äã</span><span class="w">
</span><span class="err">‚Äã</span><span class="w"> 	  </span><span class="p">}]</span><span class="w">
</span><span class="err">‚Äã</span><span class="w"> 	</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>The fields in <code class="language-plaintext highlighter-rouge">name</code> do not have to be unique.</li>
  <li>The app will be called <em>Better Book Bundle Builder</em> (or <code class="language-plaintext highlighter-rouge">B4</code> for short)</li>
  <li>To the <code class="language-plaintext highlighter-rouge">B4</code> application, the <code class="language-plaintext highlighter-rouge">books</code> index is read-only (we will not add, delete, or overwrite any documents in it).</li>
  <li>The <code class="language-plaintext highlighter-rouge">b4</code> index will store user data, including the book bundles that users make.</li>
</ul>

<p>To create the <code class="language-plaintext highlighter-rouge">b4</code> index,</p>
<ol>
  <li>make sure Elasticsearch is running,</li>
  <li>then open a terminal to the <code class="language-plaintext highlighter-rouge">esclu</code> directory</li>
  <li>Use <code class="language-plaintext highlighter-rouge">esclu</code> to create the b4 index:</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>[~/local/src/CA/sol-nodejs-the-right-way/commanding-databases-chapter-6/esclu(master)]$ ./esclu create-index -i b4
{"acknowledged":true,"shards_acknowledged":true,"index":"b4"}
[~/local/src/CA/sol-nodejs-the-right-way/commanding-databases-chapter-6/esclu(master)]$ ./esclu li
health status index    uuid                   pri rep docs.count docs.deleted store.size pri.store.size
yellow open   b4       Wt45klL2TA-p-VvYRWegoA   5   1          0            0      1.1kb          1.1kb
yellow open   accounts 9TNc0k0LQ1e4y97yFX8_vg   5   1          2            0     10.4kb         10.4kb
yellow open   books    wP3DgQPZQZq0qBtH_dd0LA   5   1      58159            3     23.2mb         23.2mb
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Our REST service is going to use ES as a service. This is the way it will work:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>+-------------------+                     +------------------+                      +------------------+
|                   |                     |                  |                      |                  |
|                   |                     |                  |                      |                  |
|                   |      request        |       OUR        |      request         |                  |
|      CLIENT       |   +--------------&gt;  |        b4        |   +--------------&gt;   |    ELASTICSEARCH |
|                   |                     |       REST       |                      |    ENGINE        |
|                   |   &lt;---------------+ |   web service    |   &lt;---------------+  |                  |
|                   |      response       |                  |      response        |                  |
|                   |                     |                  |                      |                  |
+-------------------+                     +------------------+                      +------------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>For example if the client request for info about a book, the b4 REST web service will
prepare the apropriate request for Elasticsearch, get the answer from ES and after some
filtering pass it back to the client</p>

<h2 id="how-nconf-manages-configuration-settings">How <strong>nconf</strong> manages configuration settings</h2>

<p>The <a href="https://www.npmjs.com/package/nconf">nconf</a> module manages configuration settings through a customizable hierarchy of</p>

<ul>
  <li>config files,</li>
  <li>environment variables, and</li>
  <li>command-line arguments.</li>
</ul>

<p>The order in which you load a source of configuration determines its precedence.</p>

<p>See the repo <a href="https://github.com/ULL-MII-CA-1819/learning-nconf">learning-nconf</a>
for a simple example of use.</p>

<p>See the tutorial <a href="http://blog.osmosys.asia/2017/08/18/nconf-nodejs-application/">Using nconf to configure a Node.js application</a></p>

<p>The order in which you load a source of configuration determines its precedence. Earlier values stick, meaning that later values will not overwrite them.</p>

<p><strong><a href="https://github.com/ULL-MII-CA-1819/learning-nconf/blob/master/hello-nconf.js">Code of hello-nconf.js</a></strong></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre><span class="kd">var</span> <span class="nx">fs</span>    <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">),</span>
    <span class="nx">nconf</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">nconf</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// The order in which you attach the configuration sources determines their priority in the hierarchy.</span>
<span class="c1">// Setup nconf to use (in-order):</span>
<span class="c1">//   1. Command-line arguments</span>
<span class="c1">//   2. Environment variables</span>
<span class="c1">//   3. A file located at 'path/to/config.json'</span>
<span class="c1">//</span>
<span class="nx">nconf</span><span class="p">.</span><span class="nx">argv</span><span class="p">()</span> <span class="c1">// Loads process.argv using yargs. If options is supplied it is passed along to yargs.</span>
 <span class="p">.</span><span class="nx">env</span><span class="p">(</span><span class="dl">'</span><span class="s1">__</span><span class="dl">'</span><span class="p">)</span>      <span class="c1">// Loads process.env into the hierarchy</span>
 <span class="p">.</span><span class="nx">file</span><span class="p">({</span> <span class="na">file</span><span class="p">:</span> <span class="dl">'</span><span class="s1">./config.json</span><span class="dl">'</span> <span class="p">});</span>

<span class="c1">// See "node hello-nconf.js --conf='./config-2.json'"</span>
<span class="nx">nconf</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">conf</span><span class="dl">'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">file</span><span class="p">(</span><span class="nx">nconf</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">conf</span><span class="dl">'</span><span class="p">));</span>

<span class="c1">//</span>
<span class="c1">// Set a few variables on `nconf`.</span>
<span class="c1">//</span>
<span class="nx">nconf</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">database:host</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">127.0.0.1</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">nconf</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">database:port</span><span class="dl">'</span><span class="p">,</span> <span class="mi">4000</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">foo: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">nconf</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">foo</span><span class="dl">'</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">NODE_ENV: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">nconf</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">NODE_ENV</span><span class="dl">'</span><span class="p">));</span>

<span class="c1">//</span>
<span class="c1">// Get the entire database object from nconf. This will output</span>
<span class="c1">// { host: '127.0.0.1', port: 5984 }</span>
<span class="c1">//</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">database: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">nconf</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">database</span><span class="dl">'</span><span class="p">)));</span>

<span class="c1">// It is important to note that setting keys in the File engine will not be persisted</span>
<span class="c1">// to disk until a call to .save() is made</span>
<span class="c1">// Save the configuration object to disk</span>
<span class="c1">//</span>
<span class="nx">nconf</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="dl">'</span><span class="s1">./config.json</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">()))</span>
  <span class="p">});</span>
<span class="p">});</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>The double underscore string passed to <code class="language-plaintext highlighter-rouge">env</code> means that two underscores should be used to denote object hierarchy when reading from environment variables. This is because many shell programs do not allow colon characters in variable names.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>  <span class="nx">nconf</span><span class="p">.</span><span class="nx">argv</span><span class="p">()</span>     <span class="c1">// Loads process.argv using yargs. If options is supplied it is passed along to yargs.</span>
   <span class="p">.</span><span class="nx">env</span><span class="p">(</span><span class="dl">'</span><span class="s1">__</span><span class="dl">'</span><span class="p">)</span>      <span class="c1">// Loads process.env into the hierarchy</span>
   <span class="p">.</span><span class="nx">file</span><span class="p">({</span> <span class="na">file</span><span class="p">:</span> <span class="dl">'</span><span class="s1">./config.json</span><span class="dl">'</span> <span class="p">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>Ejecuci√≥n:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>[~/local/src/javascript/learning/learning-nconf(master)]$ cat config.json
{
  "foo": "chuchu",
  "NODE_ENV": "test",
  "database": {
    "host": "titi.tutu.tata.es",
    "port": 1234
  }
}
[~/local/src/javascript/learning/learning-nconf(master)]$ node hello-nconf.js
foo: chuchu
NODE_ENV: test
database: {"host":"127.0.0.1","port":4000}
{ foo: 'chuchu',
  NODE_ENV: 'test',
  database: { host: '127.0.0.1', port: 4000 } }
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Another execution:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>[~/local/src/javascript/learning/learning-nconf(master)]$ cat config.json
{
  "foo": "chuchu",
  "NODE_ENV": "test",
  "database": {
    "host": "127.0.0.1",
    "port": 4000
  }
}[~/local/src/javascript/learning/learning-nconf(master)]$ database__host=chuchu.deioc.ull.edu.es node hello-nconf.js --foo bar
foo: bar
NODE_ENV: test
database: {"host":"chuchu.deioc.ull.edu.es","port":4000}
{ foo: 'chuchu',
  NODE_ENV: 'test',
  database: { host: '127.0.0.1', port: 4000 } }
</pre></td></tr></tbody></table></code></pre></div></div>

<p>An yet another execution using the <code class="language-plaintext highlighter-rouge">--conf</code> argument in the command line to change the config file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre>[~/local/src/javascript/learning/learning-nconf(master)]$ cat config.json
{
  "foo": "chuchu",
  "NODE_ENV": "test",
  "database": {
    "host": "127.0.0.1",
    "port": 4000
  }
}[~/local/src/javascript/learning/learning-nconf(master)]$ cat config-2.json
{
  "foo": "zas!",
  "NODE_ENV": "testing",
  "database": {
    "host": "pito.pito.gorgorito",
    "port": 1234
  }
}
[~/local/src/javascript/learning/learning-nconf(master)]$ node hello-nconf.js --conf='./config-2.json'
foo: zas!
NODE_ENV: testing
database: {"host":"127.0.0.1","port":4000}
{ foo: 'chuchu',
  NODE_ENV: 'test',
  database: { host: '127.0.0.1', port: 4000 } }
</pre></td></tr></tbody></table></code></pre></div></div>

<p>See the tutorial <a href="http://blog.osmosys.asia/2017/08/18/nconf-nodejs-application/">Using nconf to configure a Node.js application</a></p>

<h2 id="keeping-services-running-with-nodemon">Keeping Services Running with nodemon</h2>

<p><code class="language-plaintext highlighter-rouge">nodemon</code> runs a Node.js program and then automatically restarts it whenever the source code changes or if the process terminates.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>[~/local/src/CA/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7(master)]$ npm i nodemon
[~/local/src/CA/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7(master)]$ sed -ne '/dep/,/}/p' ../package.json
  "dependencies": {
    "chai": "^4.2.0",
    "cheerio": "^1.0.0-rc.2",
    "express": "^4.16.4",
    "morgan": "^1.9.1",
    "nconf": "^0.10.0",
    "node-dir": "^0.1.17",
    "nodemon": "^1.18.7",
    "zeromq": "^5.0.0",
    "zerorpc": "^0.9.8"
  }
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="separating-server-code-into-modules">Separating Server Code into Modules</h3>

<p>To start, create a directory called <code class="language-plaintext highlighter-rouge">b4</code> to house the B4 project. to optimize storage we use the <code class="language-plaintext highlighter-rouge">package.json</code> at the root project level:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre>[~/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services(master)]$ mkdir b4
[~/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services(master)]$ cd b4
[~/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ npm i nconf
+ nconf@0.10.0
added 13 packages from 17 contributors and audited 511 packages in 4.154s
found 0 vulnerabilities

[~/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ sed -ne '/dep/,/}/p' ~/sol-nodejs-the-right-way/package.json
  "dependencies": {
    "chai": "^4.2.0",
    "cheerio": "^1.0.0-rc.2",
    "express": "^4.16.4",
    "morgan": "^1.9.1",
    "nconf": "^0.10.0",
    "node-dir": "^0.1.17",
    "zeromq": "^5.0.0",
    "zerorpc": "^0.9.8"
  }
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This is our configuration file:</p>

<p><strong><a href="https://github.com/ULL-MII-CA-1819/nodejs-the-right-way/blob/master/developing-restful-web-services-chapter-7/web-services/b4/config.json#L10">Contents of web-services/b4/config.json</a></strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"port"</span><span class="p">:</span><span class="w"> </span><span class="mi">60702</span><span class="p">,</span><span class="w">
  </span><span class="nl">"es"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"localhost"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"port"</span><span class="p">:</span><span class="w"> </span><span class="mi">9200</span><span class="p">,</span><span class="w">
    </span><span class="nl">"books_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"books"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"bundles_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"b4"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><strong><a href="https://github.com/ULL-MII-CA-1819/nodejs-the-right-way/blob/master/developing-restful-web-services-chapter-7/web-services/b4/server.js">Contents of web-services/b4/server.js</a></strong></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">morgan</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">morgan</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">nconf</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">nconf</span><span class="dl">'</span><span class="p">);</span>
                  <span class="c1">// b4  web-services chapter-7</span>
<span class="kd">const</span> <span class="nx">pkg</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../../../package.json</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">nconf</span><span class="p">.</span><span class="nx">argv</span><span class="p">().</span><span class="nx">env</span><span class="p">(</span><span class="dl">'</span><span class="s1">__</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">nconf</span><span class="p">.</span><span class="nx">defaults</span><span class="p">({</span><span class="na">conf</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">__dirname</span><span class="p">}</span><span class="s2">/config.json`</span><span class="p">});</span>
<span class="nx">nconf</span><span class="p">.</span><span class="nx">file</span><span class="p">(</span><span class="nx">nconf</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">conf</span><span class="dl">'</span><span class="p">));</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">morgan</span><span class="p">(</span><span class="dl">'</span><span class="s1">dev</span><span class="dl">'</span><span class="p">));</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/version</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">pkg</span><span class="p">.</span><span class="nx">version</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./lib/search.js</span><span class="dl">'</span><span class="p">)(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">nconf</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">es</span><span class="dl">'</span><span class="p">));</span>
<span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./lib/bundle.js</span><span class="dl">'</span><span class="p">)(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">nconf</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">es</span><span class="dl">'</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">nconf</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">port</span><span class="dl">'</span><span class="p">),</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Listening on port </span><span class="dl">'</span><span class="o">+</span><span class="nx">nconf</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">port</span><span class="dl">'</span><span class="p">)));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Run the server:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>[~/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ npm run b4-server

&gt; nodejs-8-the-right-way@1.0.0 b4-server /Users/casiano/local/src/CA/sol-nodejs-the-right-way
&gt; node developing-restful-web-services-chapter-7/web-services/b4/server.js

Listening on port 60702
GET /api/version 200 3.857 ms - 5
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Run a client:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>[~/local/src/CA/sol-nodejs-the-right-way(master)]$ curl -s localhost:60702/api/version
1.0.0
</pre></td></tr></tbody></table></code></pre></div></div>
<p>or use <code class="language-plaintext highlighter-rouge">gulp</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>gulp.task("c7-b4-version", shell.task(
  `curl -s localhost:60702/api/version`
));

[~/local/src/CA/sol-nodejs-the-right-way(master)]$ gulp c7-b4-version
[10:20:46] Using gulpfile ~/local/src/CA/sol-nodejs-the-right-way/gulpfile.js
[10:20:46] Starting 'c7-b4-version'...
1.0.0[10:20:46] Finished 'c7-b4-version' after 63 ms
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="adding-search-apis">Adding Search APIs</h2>

<p>First we‚Äôll add APIs for searching the <code class="language-plaintext highlighter-rouge">books</code> index, and then we‚Äôll add APIs for creating and manipulating book bundles.</p>

<p>Add empty files <code class="language-plaintext highlighter-rouge">search.js</code> and <code class="language-plaintext highlighter-rouge">bundle.js</code>inside the <code class="language-plaintext highlighter-rouge">lib</code> folder:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>[~/.../web-services/b4(master)]$ tree
.
‚îú‚îÄ‚îÄ config.json
‚îú‚îÄ‚îÄ esclu -&gt; ../../../commanding-databases-chapter-6/esclu/esclu
‚îú‚îÄ‚îÄ lib
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ bundle.js
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ search.js
‚îú‚îÄ‚îÄ package-lock.json
‚îî‚îÄ‚îÄ server.js

1 directory, 6 files
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Next, open visual code and enter the following skeleton code for the search APIs.</p>

<p><strong>web-services/b4/lib/search.js</strong></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * Provides API endpoints for searching the books index.
 */</span>
<span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">request</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">rp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">request-promise</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">es</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`http://</span><span class="p">${</span><span class="nx">es</span><span class="p">.</span><span class="nx">host</span><span class="p">}</span><span class="s2">:</span><span class="p">${</span><span class="nx">es</span><span class="p">.</span><span class="nx">port</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">es</span><span class="p">.</span><span class="nx">books_index</span><span class="p">}</span><span class="s2">/book/_search`</span><span class="p">;</span>
<span class="p">};</span>  
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Save this file as <code class="language-plaintext highlighter-rouge">lib/search.js</code>.</p>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">app</code> parameter will be the Express application object, and</li>
  <li><code class="language-plaintext highlighter-rouge">es</code> will contain the configuration parameters relevant to Elasticsearch, as provided through <code class="language-plaintext highlighter-rouge">nconf</code></li>
</ul>

<p>The code in the server file <code class="language-plaintext highlighter-rouge">web-services/b4/server.js</code>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./lib/search.js</span><span class="dl">'</span><span class="p">)(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">nconf</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">es</span><span class="dl">'</span><span class="p">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>loads <code class="language-plaintext highlighter-rouge">lib/search.js</code> and immediately invokes the imported function by passing the <code class="language-plaintext highlighter-rouge">app</code> object and the Elastic- search configuration.</p>

<h3 id="using-requests-with-express">Using Requests with Express</h3>

<p>Let us start by giving support to requests as this one:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>[../web-services/b4(master)]$ curl -s localhost:60702/api/search/books/authors/Shakespeare | jq .[].title
"Venus and Adonis"
"The Second Part of King Henry the Sixth"
"King Richard the Second"
"The Tragedy of Romeo and Juliet"
"A Midsummer Night's Dream"
"Much Ado about Nothing"
"The Tragedy of Julius Caesar"
"As You Like It"
"The Tragedy of Othello, Moor of Venice"
"The Tragedy of Macbeth"
</pre></td></tr></tbody></table></code></pre></div></div>

<p>To achieve it:</p>

<ol>
  <li>We construct a request body ‚Äî an object that will be serialized as JSON and sent to Elasticsearch.</li>
  <li>In the second part, we‚Äôll fire off the request to Elasticsearch, handle the eventual response, and forward the results to the upstream requester that hit the API:</li>
</ol>

<p><strong>web-services/b4/lib/search.js</strong></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/search/books/:field/:query</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">esReqBody</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">size</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="c1">// limits the number of documents that will be sent back</span>
    <span class="na">query</span><span class="p">:</span> <span class="p">{</span>  <span class="c1">// describes what kind of objects we want to find</span>
      <span class="na">match</span><span class="p">:</span> <span class="p">{</span>
        <span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">field</span><span class="p">]:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">query</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="p">...</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>The Elasticsearch request body that we‚Äôre constructing conforms to Elastic-search‚Äôs Request Body Search API. It includes:
    <ul>
      <li>a <code class="language-plaintext highlighter-rouge">size</code> parameter that limits the number of documents that will be sent back, and</li>
      <li>a <code class="language-plaintext highlighter-rouge">query</code> object describing what kinds of documents we want to find.</li>
    </ul>
  </li>
  <li>When a JavaScript object literal key is surrounded with brackets, like <code class="language-plaintext highlighter-rouge">[req.params.field]</code> is here, this is called a <strong>computed property name</strong></li>
  <li>The expression inside the brackets is evaluated at runtime, and the result is used as the key.</li>
  <li>In this case, since the expression in brackets is <code class="language-plaintext highlighter-rouge">req.params.field</code>, the key used in the match object will be whatever the <code class="language-plaintext highlighter-rouge">:field</code> param of the incoming request contained.</li>
  <li>See this code:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>$ node
&gt; a = "hello"
'hello'
&gt; b = 4
4
&gt; x = {[a]: b}
{ hello: 4 }
&gt;
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ul>

<p>With the request body ready to go, add this code underneath to issue the request to Elasticsearch and handle the response:</p>

<p><strong>web-services/b4/lib/search.js</strong></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/search/books/:field/:query</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="p">...</span>
   <span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span><span class="nx">url</span><span class="p">,</span> <span class="na">json</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="nx">esReqBody</span> <span class="p">};</span>

    <span class="nx">request</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">esRes</span><span class="p">,</span> <span class="nx">esResBody</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">502</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
          <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bad_gateway</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">reason</span><span class="p">:</span> <span class="nx">err</span><span class="p">.</span><span class="nx">code</span>
        <span class="p">});</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">esRes</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">!==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">esRes</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">esResBody</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">esResBody</span><span class="p">.</span><span class="nx">hits</span><span class="p">.</span><span class="nx">hits</span><span class="p">.</span><span class="nx">map</span><span class="p">(({</span><span class="nx">_source</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">_source</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>In the first error-handling block, we deal with the case where the connection couldn‚Äôt be made at all.
    <ul>
      <li>If the <code class="language-plaintext highlighter-rouge">err</code> object is not <code class="language-plaintext highlighter-rouge">null</code>, this means that the connection to Elasticsearch failed before a response could be retrieved.</li>
      <li>Typically this would be because the Elasticsearch cluster is unreachable ‚Äî maybe it‚Äôs down, or the hostname has been misconfigured.</li>
      <li>The correct HTTP code to send back to the caller is 502 Bad Gateway.</li>
    </ul>
  </li>
  <li>In the second error-handling block, we‚Äôve received a response from Elastic- search, but it came with some HTTP status code other than <code class="language-plaintext highlighter-rouge">200 OK</code>
    <ul>
      <li>This could be for any of a variety of reasons, such as a <code class="language-plaintext highlighter-rouge">404</code> Not Found if, say, the <code class="language-plaintext highlighter-rouge">books</code> index has not been created</li>
      <li>Or during development, while you‚Äôre experimenting to get the right request body for Elasticsearch, you may receive a <code class="language-plaintext highlighter-rouge">400</code> Bad Request. In any of these cases, we just pass the response more or less straight through to the caller with the same <code class="language-plaintext highlighter-rouge">status</code> code and <code class="language-plaintext highlighter-rouge">response</code> body.</li>
    </ul>
  </li>
  <li>Finally, if there were no errors, we extract just the <code class="language-plaintext highlighter-rouge">_source</code> objects (the underlying documents) from the Elasticsearch response, and report these to the caller as JSON.
    <ul>
      <li>The <code class="language-plaintext highlighter-rouge">resBody.hits.hits.map(({_source}) =&gt; _source)</code> this is how Elasticsearch response is structured. See the response of ES to the Kibana client for the query of documents matching as author <code class="language-plaintext highlighter-rouge">Twain</code>:</li>
      <li><img src="/assets/images/es-response-books-authors-twain.png" alt="" /></li>
    </ul>
  </li>
</ul>

<p><strong><a href="https://github.com/ULL-MII-CA-1819/nodejs-the-right-way/blob/master/developing-restful-web-services-chapter-7/web-services/b4/lib/search.js">web-services/b4/lib/search.js</a></strong></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
</pre></td><td class="rouge-code"><pre><span class="cm">/**
  * Provides API endpoints for searching the book index
*/</span>
<span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">request</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">rp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">request-promise</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">es</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`http://</span><span class="p">${</span><span class="nx">es</span><span class="p">.</span><span class="nx">host</span><span class="p">}</span><span class="s2">:</span><span class="p">${</span><span class="nx">es</span><span class="p">.</span><span class="nx">port</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">es</span><span class="p">.</span><span class="nx">books_index</span><span class="p">}</span><span class="s2">/book/_search`</span><span class="p">;</span>
  <span class="cm">/**
   * Search for books matching a particular field value
   * Example: /api/search/books/authors/Twain
   */</span>
  <span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/search/books/:field/:query</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">esReqBody</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">size</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="c1">// limits the number of documents that will be sent back</span>
      <span class="na">query</span><span class="p">:</span> <span class="p">{</span>  <span class="c1">// describes what kind of objects we want to find</span>
        <span class="na">match</span><span class="p">:</span> <span class="p">{</span>
          <span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">field</span><span class="p">]:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">query</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
    <span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span><span class="nx">url</span><span class="p">,</span> <span class="na">json</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="nx">esReqBody</span> <span class="p">};</span>

    <span class="nx">request</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">esRes</span><span class="p">,</span> <span class="nx">esResBody</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">502</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
          <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bad_gateway</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">reason</span><span class="p">:</span> <span class="nx">err</span><span class="p">.</span><span class="nx">code</span>
        <span class="p">});</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">esRes</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">!==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">esRes</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">esResBody</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">esResBody</span><span class="p">.</span><span class="nx">hits</span><span class="p">.</span><span class="nx">hits</span><span class="p">.</span><span class="nx">map</span><span class="p">(({</span><span class="nx">_source</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">_source</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="cm">/**
   * Collect suggested terms for a given field based on a given query
   * Example: /api/suggest/authors/lipman
  */</span>
  <span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/suggest/:field/:query</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">esReqBody</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">size</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// We don‚Äôt want any matching documents returned, just the suggestions</span>
      <span class="na">suggest</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">suggestions</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// Elasticsearch‚Äôs Suggest API allows you to request multiple</span>
                       <span class="c1">// kinds of suggestions in the same request,</span>
                       <span class="c1">// but here we‚Äôre submitting only one. </span>
          <span class="na">text</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">query</span><span class="p">,</span>
          <span class="na">term</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">field</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">field</span><span class="p">,</span>
            <span class="na">suggest_mode</span><span class="p">:</span> <span class="dl">'</span><span class="s1">always</span><span class="dl">'</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
    <span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">url</span><span class="p">,</span> <span class="na">json</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="nx">esReqBody</span> <span class="p">};</span>
    <span class="kd">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">rp</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="cm">/*
    // Version from section: "Using a Promise with request", pages 162-166
    const promise = new Promise((resolve, reject) =&gt; {
      request.get(options, (err, esRes, esResBody) =&gt; {
        if (err) {
          reject({error: err});
          return;
        }
        if (esRes.statusCode !== 200) {
          reject({error: esResBody});
          return;
        }
        resolve(esResBody);
      });
    });
    */</span>
    <span class="nx">promise</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">esResBody</span> <span class="o">=&gt;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">esResBody</span><span class="p">.</span><span class="nx">suggest</span><span class="p">.</span><span class="nx">suggestions</span><span class="p">)</span>
      <span class="p">)</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">(</span>
        <span class="p">({</span><span class="nx">error</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">status</span> <span class="o">||</span> <span class="mi">502</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
      <span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query.html">Elasticsearch Match Query</a>
    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/search/books/:field/:query</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
<span class="kd">const</span> <span class="nx">esReqBody</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">size</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="c1">// limits the number of documents that will be sent back</span>
  <span class="na">query</span><span class="p">:</span> <span class="p">{</span>  <span class="c1">// describes what kind of objects we want to find</span>
    <span class="na">match</span><span class="p">:</span> <span class="p">{</span>
      <span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">field</span><span class="p">]:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">query</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span><span class="nx">url</span><span class="p">,</span> <span class="na">json</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="nx">esReqBody</span> <span class="p">};</span>

<span class="nx">request</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">esRes</span><span class="p">,</span> <span class="nx">esResBody</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">502</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
      <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bad_gateway</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">reason</span><span class="p">:</span> <span class="nx">err</span><span class="p">.</span><span class="nx">code</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">esRes</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">!==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">esRes</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">esResBody</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">esResBody</span><span class="p">.</span><span class="nx">hits</span><span class="p">.</span><span class="nx">hits</span><span class="p">.</span><span class="nx">map</span><span class="p">(({</span><span class="nx">_source</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">_source</span><span class="p">));</span>
<span class="p">});</span>
<span class="p">});</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li><a href="https://developer.mozilla.org/es/docs/Web/HTTP/Status/502">Status 502: Puerta de enlace no v√°lida</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/current/errors.html">Elasticsearch errors</a></li>
</ul>

<p><strong><a href="https://github.com/ULL-MII-CA-1819/nodejs-the-right-way/blob/master/developing-restful-web-services-chapter-7/web-services/b4/server.js">web-services/b4/server.js</a></strong></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">morgan</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">morgan</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">nconf</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">nconf</span><span class="dl">'</span><span class="p">);</span>
                  <span class="c1">// b4  web-services chapter-7</span>
<span class="kd">const</span> <span class="nx">pkg</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../../../package.json</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">nconf</span><span class="p">.</span><span class="nx">argv</span><span class="p">().</span><span class="nx">env</span><span class="p">(</span><span class="dl">'</span><span class="s1">__</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">nconf</span><span class="p">.</span><span class="nx">defaults</span><span class="p">({</span><span class="na">conf</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">__dirname</span><span class="p">}</span><span class="s2">/config.json`</span><span class="p">});</span>
<span class="nx">nconf</span><span class="p">.</span><span class="nx">file</span><span class="p">(</span><span class="nx">nconf</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">conf</span><span class="dl">'</span><span class="p">));</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">morgan</span><span class="p">(</span><span class="dl">'</span><span class="s1">dev</span><span class="dl">'</span><span class="p">));</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/version</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">pkg</span><span class="p">.</span><span class="nx">version</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./lib/search.js</span><span class="dl">'</span><span class="p">)(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">nconf</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">es</span><span class="dl">'</span><span class="p">));</span>
<span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./lib/bundle.js</span><span class="dl">'</span><span class="p">)(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">nconf</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">es</span><span class="dl">'</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">nconf</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">port</span><span class="dl">'</span><span class="p">),</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Listening on port </span><span class="dl">'</span><span class="o">+</span><span class="nx">nconf</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">port</span><span class="dl">'</span><span class="p">)));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong><a href="https://github.com/ULL-MII-CA-1819/nodejs-the-right-way/blob/master/developing-restful-web-services-chapter-7/web-services/b4/config.json">web-services/b4/config.json</a></strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"port"</span><span class="p">:</span><span class="w"> </span><span class="mi">60702</span><span class="p">,</span><span class="w">
  </span><span class="nl">"es"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"localhost"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"port"</span><span class="p">:</span><span class="w"> </span><span class="mi">9200</span><span class="p">,</span><span class="w">
    </span><span class="nl">"books_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"books"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"bundles_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"b4"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>Executions:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>[~/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ grep b4-server ../../../package.json
    "test-now": "npm run b4-server",
    "b4-server": "node developing-restful-web-services-chapter-7/web-services/b4/server.js",
    "b4-server-nodemon": "nodemon developing-restful-web-services-chapter-7/web-services/b4/server.js",
[~/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ npm run b4-server

&gt; nodejs-8-the-right-way@1.0.0 b4-server /Users/casiano/local/src/CA/sol-nodejs-the-right-way
&gt; node developing-restful-web-services-chapter-7/web-services/b4/server.js

Listening on port 60702
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>[~/local/src/CA/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ sed -ne '/c7-b4-get/,/));/p' ../../../gulpfile.js
gulp.task("c7-b4-get-shakespeare", shell.task(
  `curl -s localhost:60702/api/search/books/authors/Shakespeare | jq .[].title`
));
gulp.task("c7-b4-get-sawyer", shell.task(
  `curl -s localhost:60702/api/search/books/title/sawyer | jq .[].title`
));
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>[~/local/src/CA/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ curl -s localhost:60702/api/search/books/authors/Shakespeare | jq .[].title
"Venus and Adonis"
"The Second Part of King Henry the Sixth"
"King Richard the Second"
"The Tragedy of Romeo and Juliet"
"A Midsummer Night's Dream"
"Much Ado about Nothing"
"The Tragedy of Julius Caesar"
"As You Like It"
"The Tragedy of Othello, Moor of Venice"
"The Tragedy of Macbeth"
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>[~/local/src/CA/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ curl -s localhost:60702/api/search/books/title/sawyer | jq .[].title
"Tom Sawyer Abroad"
"Tom Sawyer, Detective"
"Tom Sawyer Abroad"
"Tom Sawyer, Detective"
"The Adventures of Tom Sawyer"
"Tom Sawyer: Koulupojan historia"
"Tom Sawyer ilmailija\nHuckleberry Finn'in jatko"
"The Adventures of Tom Sawyer, Part 3."
"De Lotgevallen van Tom Sawyer"
"The Adventures of Tom Sawyer"
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="simplifying-code-flows-with-promises">Simplifying Code Flows with Promises</h2>

<h3 id="fulfilling-promises">Fulfilling Promises</h3>

<ul>
  <li><a href="https://ull-mii-ca-1819.github.io/learning-js/_book/async-js/async-js.html">Apuntes del profesor en Async JS</a></li>
  <li><a href="https://nodejs.org/api/events.html#events_error_events">Node.js Events: Error Events</a>
    <ul>
      <li>When an error occurs within an <code class="language-plaintext highlighter-rouge">EventEmitter</code> instance, the typical action is for an <code class="language-plaintext highlighter-rouge">error</code> event to be emitted. These are treated as special cases within Node.js.</li>
      <li>If an <code class="language-plaintext highlighter-rouge">EventEmitter</code> does not have at least one listener registered for the <code class="language-plaintext highlighter-rouge">error</code> event, and an <code class="language-plaintext highlighter-rouge">error</code> event is emitted, the error is thrown, a stack trace is printed, and the Node.js process exits.</li>
    </ul>
  </li>
  <li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">The Promise Class at developer.mozilla.org</a></li>
</ul>

<h3 id="using-a-promise-with-request">Using a Promise with Request</h3>

<ul>
  <li><a href="https://github.com/ULL-MII-CA-1819/nodejs-the-right-way/blob/master/developing-restful-web-services-chapter-7/web-services/b4/lib/search.js#L59-L74">Code of the Promise object for making the <code class="language-plaintext highlighter-rouge">/api/suggest</code> request</a>
    <ul>
      <li><a href="https://github.com/ULL-MII-CA-1819/nodejs-the-right-way/blob/master/developing-restful-web-services-chapter-7/web-services/b4/lib/search.js#L38-L77">Final code for the route /api/suggest/:field/:query in developing-restful-web-services-chapter-7/web-services/b4/lib/search.js</a></li>
    </ul>
  </li>
  <li>Elasticsearch suggest
    <ul>
      <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-suggesters-term.html">The Elasticsearch <code class="language-plaintext highlighter-rouge">term</code> suggester suggests terms based on edit distance. The provided suggest text is analyzed before terms are suggested. The suggested terms are provided per analyzed suggest text token. The <code class="language-plaintext highlighter-rouge">term</code> suggester doesn‚Äôt take the query into account that is part of request.</a></li>
      <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/search-suggesters.html">Elasticsearch Suggesters: The suggest feature suggests similar looking terms based on a provided text by using a suggester</a></li>
    </ul>
  </li>
</ul>

<h4 id="example-of-request-to-the-elasticsearch-suggest-api-with-curl">Example of request to the Elasticsearch suggest API with <code class="language-plaintext highlighter-rouge">curl</code></h4>

<p><strong><a href="https://github.com/ULL-MII-CA-1819/nodejs-the-right-way/blob/master/gulpfile.js#L358-L396">Code in gulpfile for task c7-es-suggest</a></strong>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">let</span> <span class="nx">trimnl</span> <span class="o">=</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">\s</span><span class="sr">+/g</span><span class="p">,</span><span class="dl">""</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">trimnl</span><span class="p">(</span><span class="s2">`
  {
  	"size": 0,
  	"suggest": {
  		"suggestions": {
  			"text": "lipman",
  			"term": {
  				"field": "authors",
  				"suggest_mode": "always"
  			}
  		}
  	}
  }
`</span><span class="p">);</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">'</span><span class="s1">c7-es-suggest</span><span class="dl">'</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
  <span class="s2">`curl -s  -H 'Content-Type: application/json' -d '</span><span class="p">${</span><span class="nx">request</span><span class="p">}</span><span class="s2">' -X GET localhost:9200/books/book/_search | jq .suggest.suggestions`</span>
<span class="p">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Respuesta del servidor es:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="o">[</span>~/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4<span class="o">(</span>master<span class="o">)]</span><span class="nv">$ </span>gulp c7-es-suggest
<span class="o">[</span>14:48:59] Working directory changed to ~/local/src/CA/sol-nodejs-the-right-way
<span class="o">[</span>14:49:00] Using gulpfile ~/local/src/CA/sol-nodejs-the-right-way/gulpfile.js
<span class="o">[</span>14:49:00] Starting <span class="s1">'c7-es-suggest'</span>...
<span class="o">[</span>
  <span class="o">{</span>
    <span class="s2">"text"</span>: <span class="s2">"lipman"</span>,
    <span class="s2">"offset"</span>: 0,
    <span class="s2">"length"</span>: 6,
    <span class="s2">"options"</span>: <span class="o">[</span>
      <span class="o">{</span>
        <span class="s2">"text"</span>: <span class="s2">"lilian"</span>,
        <span class="s2">"score"</span>: 0.6666666,
        <span class="s2">"freq"</span>: 30
      <span class="o">}</span>,
      <span class="o">{</span>
        <span class="s2">"text"</span>: <span class="s2">"lanman"</span>,
        <span class="s2">"score"</span>: 0.6666666,
        <span class="s2">"freq"</span>: 7
      <span class="o">}</span>,
      <span class="o">{</span>
        <span class="s2">"text"</span>: <span class="s2">"lippmann"</span>,
        <span class="s2">"score"</span>: 0.6666666,
        <span class="s2">"freq"</span>: 6
      <span class="o">}</span>,
      <span class="o">{</span>
        <span class="s2">"text"</span>: <span class="s2">"lampman"</span>,
        <span class="s2">"score"</span>: 0.6666666,
        <span class="s2">"freq"</span>: 3
      <span class="o">}</span>,
      <span class="o">{</span>
        <span class="s2">"text"</span>: <span class="s2">"lehman"</span>,
        <span class="s2">"score"</span>: 0.6666666,
        <span class="s2">"freq"</span>: 3
      <span class="o">}</span>
    <span class="o">]</span>
  <span class="o">}</span>
<span class="o">]</span>
<span class="o">[</span>14:49:00] Finished <span class="s1">'c7-es-suggest'</span> after 66 ms
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="example-of-request-to-the-elasticsearch-suggest-api-with-postman">Example of request to the Elasticsearch suggest API with <code class="language-plaintext highlighter-rouge">postman</code></h4>

<p><img src="images/postman-request-2-es-suggest-api.png" alt="" /></p>

<h4 id="code-for-the-route-apisuggestfieldquery">Code for the Route ‚Äò/api/suggest/:field/:query‚Äô</h4>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * Collect suggested terms for a given field based on a given query
 * Example: /api/suggest/authors/lipman
*/</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/suggest/:field/:query</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">esReqBody</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">size</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="na">suggest</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">suggestions</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">text</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">query</span><span class="p">,</span>
        <span class="na">term</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">field</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">field</span><span class="p">,</span>
          <span class="na">suggest_mode</span><span class="p">:</span> <span class="dl">'</span><span class="s1">always</span><span class="dl">'</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">url</span><span class="p">,</span> <span class="na">json</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="nx">esReqBody</span> <span class="p">};</span>
  <span class="kd">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">esRes</span><span class="p">,</span> <span class="nx">esResBody</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reject</span><span class="p">({</span><span class="na">error</span><span class="p">:</span> <span class="nx">err</span><span class="p">});</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">esRes</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">!==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reject</span><span class="p">({</span><span class="na">error</span><span class="p">:</span> <span class="nx">esResBody</span><span class="p">});</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">resolve</span><span class="p">(</span><span class="nx">esResBody</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="nx">promise</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">esResBody</span> <span class="o">=&gt;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">esResBody</span><span class="p">.</span><span class="nx">suggest</span><span class="p">.</span><span class="nx">suggestions</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span>
      <span class="p">({</span><span class="nx">error</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">status</span> <span class="o">||</span> <span class="mi">502</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
    <span class="p">);</span>
<span class="p">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>When making a request with curl we get:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>[~/local/src/CA/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ curl -s localhost:60702/api/suggest/authors/lipman | jq .[].options[].text
"lilian"
"lanman"
"lippmann"
"lampman"
"lehman"
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="replacing-request-with-request-promise">Replacing request with request-promise</h3>

<ul>
  <li><a href="https://github.com/request/request-promise">request-promise</a> GitHub</li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="o">~</span><span class="sr">/local/</span><span class="nx">src</span><span class="o">/</span><span class="nx">CA</span><span class="o">/</span><span class="nx">sol</span><span class="o">-</span><span class="nx">nodejs</span><span class="o">-</span><span class="nx">the</span><span class="o">-</span><span class="nx">right</span><span class="o">-</span><span class="nx">way</span><span class="o">/</span><span class="nx">developing</span><span class="o">-</span><span class="nx">restful</span><span class="o">-</span><span class="nx">web</span><span class="o">-</span><span class="nx">services</span><span class="o">-</span><span class="nx">chapter</span><span class="o">-</span><span class="mi">7</span><span class="o">/</span><span class="nx">web</span><span class="o">-</span><span class="nx">services</span><span class="o">/</span><span class="nx">b4</span><span class="p">(</span><span class="nx">master</span><span class="p">)]</span><span class="nx">$</span> <span class="nx">cat</span> <span class="o">-</span><span class="nx">n</span> <span class="nx">lib</span><span class="o">/</span><span class="nx">search</span><span class="p">.</span><span class="nx">js</span>
     <span class="p">.........</span>
     <span class="mi">5</span>	<span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">request</span><span class="dl">'</span><span class="p">);</span>
     <span class="mi">6</span>	<span class="kd">const</span> <span class="nx">rp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">request-promise</span><span class="dl">'</span><span class="p">);</span>
     <span class="mi">7</span>
     <span class="mi">8</span>	<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">es</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
     <span class="mi">9</span>	  <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`http://</span><span class="p">${</span><span class="nx">es</span><span class="p">.</span><span class="nx">host</span><span class="p">}</span><span class="s2">:</span><span class="p">${</span><span class="nx">es</span><span class="p">.</span><span class="nx">port</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">es</span><span class="p">.</span><span class="nx">books_index</span><span class="p">}</span><span class="s2">/book/_search`</span><span class="p">;</span>
    <span class="mi">10</span>	  <span class="cm">/**
    11	   * Search for books matching a particular field value
    12	   * Example: /api/search/books/authors/Twain
    13	   */</span>
    <span class="mi">14</span>	  <span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/search/books/:field/:query</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="p">..........</span>
    <span class="mi">38</span>	  <span class="p">});</span>
    <span class="mi">39</span>
    <span class="mi">40</span>	  <span class="cm">/**
    41	   * Collect suggested terms for a given field based on a given query
    42	   * Example: /api/suggest/authors/lipman
    43	  */</span>
    <span class="mi">44</span>	  <span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/suggest/:field/:query</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="mi">45</span>	    <span class="kd">const</span> <span class="nx">esReqBody</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">46</span>	      <span class="na">size</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="mi">47</span>	      <span class="na">suggest</span><span class="p">:</span> <span class="p">{</span>
    <span class="mi">48</span>	        <span class="na">suggestions</span><span class="p">:</span> <span class="p">{</span>
    <span class="mi">49</span>	          <span class="na">text</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">query</span><span class="p">,</span>
    <span class="mi">50</span>	          <span class="na">term</span><span class="p">:</span> <span class="p">{</span>
    <span class="mi">51</span>	            <span class="na">field</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">field</span><span class="p">,</span>
    <span class="mi">52</span>	            <span class="na">suggest_mode</span><span class="p">:</span> <span class="dl">'</span><span class="s1">always</span><span class="dl">'</span>
    <span class="mi">53</span>	          <span class="p">}</span>
    <span class="mi">54</span>	        <span class="p">}</span>
    <span class="mi">55</span>	      <span class="p">}</span>
    <span class="mi">56</span>	    <span class="p">};</span>
    <span class="mi">57</span>	    <span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">url</span><span class="p">,</span> <span class="na">json</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="nx">esReqBody</span> <span class="p">};</span>
    <span class="mi">58</span>	    <span class="kd">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">rp</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="mi">59</span>	    <span class="cm">/*
    60	    // Version from section: "Using a Promise with request", pages 162-166
    61	    const promise = new Promise((resolve, reject) =&gt; {
    62	      request.get(options, (err, esRes, esResBody) =&gt; {
    63	        if (err) {
    64	          reject({error: err});
    65	          return;
    66	        }
    67	        if (esRes.statusCode !== 200) {
    68	          reject({error: esResBody});
    69	          return;
    70	        }
    71	        resolve(esResBody);
    72	      });
    73	    });
    74	    */</span>
    <span class="mi">75</span>	    <span class="nx">promise</span>
    <span class="mi">76</span>	      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">esResBody</span> <span class="o">=&gt;</span>
    <span class="mi">77</span>	        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">esResBody</span><span class="p">.</span><span class="nx">suggest</span><span class="p">.</span><span class="nx">suggestions</span><span class="p">)</span>
    <span class="mi">78</span>	      <span class="p">)</span>
    <span class="mi">79</span>	      <span class="p">.</span><span class="k">catch</span><span class="p">(</span>
    <span class="mi">80</span>	        <span class="p">({</span><span class="nx">error</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">status</span> <span class="o">||</span> <span class="mi">502</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
    <span class="mi">81</span>	      <span class="p">);</span>
    <span class="mi">82</span>	  <span class="p">});</span>
    <span class="mi">83</span>	<span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="manipulating-documents-restfully">Manipulating Documents RESTfully</h2>

<ul>
  <li>In this part, we‚Äôll be creating APIs for manipulating book bundles.</li>
  <li>A book bundle has a <code class="language-plaintext highlighter-rouge">name</code> and maintains a collection of related books.</li>
</ul>

<p>Here‚Äôs an example of a book bundle:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="err">‚Äã</span>  <span class="p">{</span>
<span class="err">‚Äã</span>    <span class="err">‚Äã</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="err">‚Äã</span><span class="p">:</span> <span class="err">‚Äã</span><span class="dl">"</span><span class="s2">light reading</span><span class="dl">"</span><span class="err">‚Äã</span><span class="p">,</span>
<span class="err">‚Äã</span>    <span class="err">‚Äã</span><span class="dl">"</span><span class="s2">books</span><span class="dl">"</span><span class="err">‚Äã</span><span class="p">:</span> <span class="p">[</span>
       <span class="p">{</span>
  <span class="err">‚Äã</span>      <span class="err">‚Äã</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="err">‚Äã</span><span class="p">:</span> <span class="err">‚Äã</span><span class="dl">"</span><span class="s2">pg132</span><span class="dl">"</span><span class="err">‚Äã</span><span class="p">,</span>
  <span class="err">‚Äã</span>      <span class="err">‚Äã</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="err">‚Äã</span><span class="p">:</span> <span class="err">‚Äã</span><span class="dl">"</span><span class="s2">The Art of War</span><span class="dl">"</span><span class="err">‚Äã</span>
  <span class="err">‚Äã</span>     <span class="p">},</span>
       <span class="p">{</span>
        <span class="err">‚Äã</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="err">‚Äã</span><span class="p">:</span> <span class="err">‚Äã</span><span class="dl">"</span><span class="s2">pg2680</span><span class="dl">"</span><span class="err">‚Äã</span><span class="p">,</span>
  <span class="err">‚Äã</span>      <span class="err">‚Äã</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="err">‚Äã</span><span class="p">:</span> <span class="err">‚Äã</span><span class="dl">"</span><span class="s2">Meditations</span><span class="dl">"</span><span class="err">‚Äã</span><span class="p">,</span>
  <span class="err">‚Äã</span>     <span class="p">},</span>
       <span class="p">{</span>
  <span class="err">‚Äã</span>      <span class="err">‚Äã</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="err">‚Äã</span><span class="p">:</span> <span class="err">‚Äã</span><span class="dl">"</span><span class="s2">pg6456</span><span class="dl">"</span><span class="err">‚Äã</span><span class="p">,</span>
  <span class="err">‚Äã</span>      <span class="err">‚Äã</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="err">‚Äã</span><span class="p">:</span> <span class="err">‚Äã</span><span class="dl">"</span><span class="s2">Public Opinion</span><span class="dl">"</span><span class="err">‚Äã</span>
  <span class="err">‚Äã</span>     <span class="p">}</span>
     <span class="p">]</span>
<span class="err">‚Äã</span>  <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Creating these APIs will be programmatically more intensive than creating the search APIs because
<strong>they require more back-and-forth between your Node.js service and the underlying datastore</strong>.</p>

<p>For example, consider an API to update the <code class="language-plaintext highlighter-rouge">name</code> of a bundle. Our Node.js code will need to do the following:</p>

<ol>
  <li>Retrieve the bundle from Elasticsearch.</li>
  <li>Update the <code class="language-plaintext highlighter-rouge">name</code> field on the object in memory.</li>
  <li>Put the updated object back into Elasticsearch.</li>
</ol>

<p>In addition to handling these asynchronously and in order, you‚Äôll have to deal with various failure modes.</p>
<ul>
  <li>What if Elasticsearch is down?</li>
  <li>What if the bundle doesn‚Äôt exist?</li>
  <li>What if the bundle changed between the time Node.js downloaded it and the time it reuploaded it?</li>
  <li>What if Elasticsearch fails to update for some other reason?</li>
</ul>

<p>There are a lot of ways a sequence of asynchronous events could fail midstride, and it‚Äôs important to think about what kind of response you should provide to users of your API:</p>
<ul>
  <li>What HTTP status code is closest to explaining the situation?</li>
  <li>What kind of error message should you present?</li>
</ul>

<p>Fichero <a href="https://github.com/ULL-MII-CA-1819/nodejs-the-right-way/blob/master/developing-restful-web-services-chapter-7/web-services/b4/lib/bundle.js"><code class="language-plaintext highlighter-rouge">lib/bundle.js</code></a>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * Provide API endpoints for working with book bundles_index
 */</span>
<span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">rp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">request-promise</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">es</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`http://</span><span class="p">${</span><span class="nx">es</span><span class="p">.</span><span class="nx">host</span><span class="p">}</span><span class="s2">:</span><span class="p">${</span><span class="nx">es</span><span class="p">.</span><span class="nx">port</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">es</span><span class="p">.</span><span class="nx">bundles_index</span><span class="p">}</span><span class="s2">/bundle`</span><span class="p">;</span>

  <span class="cm">/**
   * Create a new bundle with the specified names
   * Example: curl -X POST http://&lt;host&gt;:&lt;port&gt;/api/bundle?name=&lt;name&gt;
   */</span>
   <span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/bundle</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">bundle</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">name</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="dl">''</span><span class="p">,</span>
        <span class="na">books</span><span class="p">:</span> <span class="p">[]</span>

      <span class="p">};</span>

      <span class="nx">rp</span><span class="p">.</span><span class="nx">post</span><span class="p">({</span><span class="nx">url</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="nx">bundle</span><span class="p">,</span> <span class="na">json</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">esResBody</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">esResBody</span><span class="p">))</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(({</span><span class="nx">error</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">status</span> <span class="o">||</span> <span class="mi">502</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">error</span><span class="p">));</span>
   <span class="p">});</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>A√±adimos la dependencia de <code class="language-plaintext highlighter-rouge">lib/bundle.js</code> en <a href="https://github.com/ULL-MII-CA-1819/nodejs-the-right-way/blob/master/developing-restful-web-services-chapter-7/web-services/b4/server.js#L21"><code class="language-plaintext highlighter-rouge">server.js</code></a>:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="err">[~/local/src/CA/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$</span> git diff server.js
<span class="gh">diff --git a/developing-restful-web-services-chapter-7/web-services/b4/server.js b/developing-restful-web-services-chapter-7/web-services/b4/server.js
index 82ca3f1..c17bc87 100644
</span><span class="gd">--- a/developing-restful-web-services-chapter-7/web-services/b4/server.js
</span><span class="gi">+++ b/developing-restful-web-services-chapter-7/web-services/b4/server.js
</span><span class="p">@@ -18,4 +18,5 @@</span> app.get('/api/version', (req, res) =&gt; {
 });

 require('./lib/search.js')(app, nconf.get('es'));
<span class="gi">+require('./lib/bundle.js')(app, nconf.get('es'));
</span> app.listen(nconf.get('port'), () =&gt; console.log('Listening on port '+nconf.get('port')));
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Create a bundle using <code class="language-plaintext highlighter-rouge">curl</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>[~/local/src/CA/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ curl -s -X POST localhost:60702/api/bundle/?name=light%20reading | jq .
{
  "_index": "b4",
  "_type": "bundle",
  "_id": "zLkMWmcB1uX03maR3vEQ",
  "_version": 1,
  "result": "created",
  "_shards": {
    "total": 2,
    "successful": 1,
    "failed": 0
  },
  "_seq_no": 0,
  "_primary_term": 1
}
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>Note the <code class="language-plaintext highlighter-rouge">_id</code> field.</li>
  <li>This is automatically generated by Elasticsearch for the new bundle document that was just created.</li>
  <li>Copy this string, as you‚Äôll need it for the remaining examples in this chapter.</li>
  <li>It may help to put it in an environment variable for easy retrieval.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>[~/local/src/CA/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ BUNDLE_ID=zLkMWmcB1uX03maR3vEQ
[~/local/src/CA/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ echo $BUNDLE_ID
zLkMWmcB1uX03maR3vEQ
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Using <code class="language-plaintext highlighter-rouge">curl</code>, we can hit Elasticsearch directly to check on this bundle document.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>~/local/src/CA/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ curl -s localhost:9200/b4/bundle/$BUNDLE_ID | jq .
{
  "_index": "b4",
  "_type": "bundle",
  "_id": "zLkMWmcB1uX03maR3vEQ",
  "_version": 1,
  "found": true,
  "_source": {
    "name": "light reading",
    "books": []
  }
}
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="emulating-synchronous-style-with-async-and-await">Emulating Synchronous Style with async and await</h2>

<p>We‚Äôll add an API to perform exactly lookups for the bundles without having to go to Elasticsearch directly.</p>

<ul>
  <li>
    <p><a href="https://ull-mii-ca-1819.github.io/learning-js/_book/async-js/async-js.html">Cap√≠tulo Async JS en los apuntes</a></p>
  </li>
  <li><a href="https://youtu.be/TCYhr_UMZkI">How does async/await work with TypeScript and ECMAScript 2017? - Firecasts</a> YouTube (menos de 8 minutos)</li>
  <li><a href="https://youtu.be/u2axmPnxUoo">async await explicado en menos de 15 minutos (y muy bien)</a> V√≠deo en YouTube por Ricardo Macario</li>
  <li><a href="https://youtu.be/za8Z6saKVdw">async-await explicado en menos de cuatro minutos</a> V√≠deo ‚ÄúJavascript as√≠ncrono con Async Await‚Äù de Carlos Villuendas</li>
</ul>

<p><strong>An async function can be intentionally suspended midexecution to wait on the resolution of a Promise</strong></p>

<h2 id="providing-an-async-handler-function-to-express">Providing an Async Handler Function to Express</h2>

<p>En <a href="https://github.com/ULL-MII-CA-1819/nodejs-the-right-way/blob/master/developing-restful-web-services-chapter-7/web-services/b4/lib/bundle.js#L26-L38"><code class="language-plaintext highlighter-rouge">web-services/b4/bundle.js</code></a> a√±adimos:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/bundle/:id</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">url</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">url</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
    <span class="na">json</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">};</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">esResBody</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">rp</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">esResBody</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">esResErr</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">esResErr</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">||</span> <span class="mi">502</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">esResErr</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>~/local/src/CA/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ echo $BUNDLE_ID
zLkMWmcB1uX03maR3vEQ
[~/local/src/CA/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ curl -s localhost:60702/api/bundle/$BUNDLE_ID | jq .
{
  "_index": "b4",
  "_type": "bundle",
  "_id": "zLkMWmcB1uX03maR3vEQ",
  "_version": 1,
  "found": true,
  "_source": {
    "name": "light reading",
    "books": []
  }
}
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>[~/local/src/CA/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ curl -s localhost:60702/api/bundle/no-such-bundle | jq .
{
  "_index": "b4",
  "_type": "bundle",
  "_id": "no-such-bundle",
  "found": false
}
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>[~/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ npm run b4-server
Listening on port 60702
POST /api/bundle/?name=light%20reading 201 107.544 ms - 171
GET /api/bundle/zLkMWmcB1uX03maR3vEQ 200 23.765 ms - 133
GET /api/bundle/no-such-bundle 404 39.392 ms - 69
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c1">// BAD IMPLEMENTATION! async Express handler without a try/catch block</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/err-bundle/:id</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">url</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">url</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
    <span class="na">json</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">esResBody</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">rp</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">esResBody</span><span class="p">);</span>
<span class="p">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>[~/local/src/CA/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ curl -s localhost:60702/api/err-bundle/no-such-bundle
</pre></td></tr></tbody></table></code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">curl</code> seems to never terminate. It hangs after sending the request waiting for a response that will never arrive.</p>

<p>Notice the warning messages in the server terminal:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>~/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ npm run b4-server

&gt; nodejs-8-the-right-way@1.0.0 b4-server /Users/casiano/local/src/CA/sol-nodejs-the-right-way
&gt; node developing-restful-web-services-chapter-7/web-services/b4/server.js

Listening on port 60702
(node:73832) UnhandledPromiseRejectionWarning: StatusCodeError: 404 - {"_index":"b4","_type":"bundle","_id":"no-such-bundle","found":false}
    at new StatusCodeError
    .........
(node:73832) UnhandledPromiseRejectionWarning: Unhandled promise rejection. This error originated either by throwing inside of an async function without a catch block, or by rejecting a promise which was not handled with .catch(). (rejection id: 1)
(node:73832) [DEP0018] DeprecationWarning: Unhandled promise rejections are deprecated. In the future, promise rejections that are not handled will terminate the Node.js process with a non-zero exit code.
GET /api/err-bundle/no-such-bundle - - ms - -
</pre></td></tr></tbody></table></code></pre></div></div>

<p>It turns out that indeed the <code class="language-plaintext highlighter-rouge">await</code> clause triggers the rejection object to be thrown, but since it‚Äôs not caught inside the <code class="language-plaintext highlighter-rouge">async</code> function, it bubbles up to a <code class="language-plaintext highlighter-rouge">Promise</code> returned by the <code class="language-plaintext highlighter-rouge">async</code> function itself.</p>

<p>That <code class="language-plaintext highlighter-rouge">Promise</code> is rejected, but since its rejection wasn‚Äôt handled, we get warnings.</p>

<h3 id="setting-the-bundle-name-with-put">Setting the Bundle Name with PUT</h3>

<p>File <a href="https://github.com/ULL-MII-CA-1819/nodejs-the-right-way/blob/master/developing-restful-web-services-chapter-7/web-services/b4/lib/bundle.js#L51-L67"><code class="language-plaintext highlighter-rouge">web-services/b4/lib/bundle.js</code></a>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * Set the :id bundle's name to the provide :name
 * curl -X PUT http://&lt;host&gt;:&lt;port&gt;/api/bundle/&lt;id&gt;/name/&lt;name&gt;
 */</span>
 <span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/bundle/:id/name/:name</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="kd">const</span> <span class="nx">bundleUrl</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">url</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>

   <span class="k">try</span> <span class="p">{</span>
     <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">rp</span><span class="p">.</span><span class="kd">get</span><span class="p">({</span><span class="na">url</span><span class="p">:</span> <span class="nx">bundleUrl</span><span class="p">,</span> <span class="na">json</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
     <span class="kd">const</span> <span class="nx">bundle</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">_source</span><span class="p">;</span>
     <span class="nx">bundle</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
     <span class="kd">const</span> <span class="nx">esResBody</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">rp</span><span class="p">.</span><span class="nx">put</span><span class="p">({</span><span class="na">url</span><span class="p">:</span> <span class="nx">bundleUrl</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="nx">bundle</span><span class="p">,</span> <span class="na">json</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
     <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">esResBody</span><span class="p">);</span>
   <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">esResErr</span><span class="p">)</span> <span class="p">{</span>
     <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">esResErr</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">||</span> <span class="mi">502</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">esResErr</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
   <span class="p">}</span>
 <span class="p">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>[~/local/src/CA/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ curl -s -X PUT localhost:60702/api/bundle/$BUNDLE_ID/name/foo | jq .
{
  "_index": "b4",
  "_type": "bundle",
  "_id": "zLkMWmcB1uX03maR3vEQ",
  "_version": 2,
  "result": "updated",
  "_shards": {
    "total": 2,
    "successful": 1,
    "failed": 0
  },
  "_seq_no": 1,
  "_primary_term": 1
}
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>[~/local/src/CA/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ curl -s localhost:60702/api/bundle/$BUNDLE_ID | jq .
{
  "_index": "b4",
  "_type": "bundle",
  "_id": "zLkMWmcB1uX03maR3vEQ",
  "_version": 2,
  "found": true,
  "_source": {
    "name": "foo",
    "books": []
  }
}
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="putting-a-book-into-a-bundle">Putting a Book into a Bundle</h3>

<p>In this section, we‚Äôll add an API endpoint for putting a book into a bundle.</p>

<ul>
  <li><a href="https://github.com/ULL-MII-CA-1819/nodejs-the-right-way/blob/master/developing-restful-web-services-chapter-7/web-services/b4/lib/bundle.js#L69-L113">Code of web-services/b4/lib/bundle.js</a></li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="rouge-code"><pre>    <span class="cm">/**
     * Put a book into a bundle by its id
     * curl -X PUT http://&lt;host&gt;:&lt;port&gt;/api/bundle/&lt;id&gt;/book/&lt;pgid&gt;
    */</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/bundle/:id/book/:pgid</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">debugger</span><span class="p">;</span>
      <span class="kd">const</span> <span class="nx">bundleUrl</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">url</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
      <span class="kd">const</span> <span class="nx">bookUrl</span> <span class="o">=</span> <span class="s2">`http://</span><span class="p">${</span><span class="nx">es</span><span class="p">.</span><span class="nx">host</span><span class="p">}</span><span class="s2">:</span><span class="p">${</span><span class="nx">es</span><span class="p">.</span><span class="nx">port</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">es</span><span class="p">.</span><span class="nx">books_index</span><span class="p">}</span><span class="s2">/book/</span><span class="p">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">pgid</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="c1">// Request the bundle and book in parallel</span>
        <span class="kd">const</span> <span class="p">[</span><span class="nx">bundleRes</span><span class="p">,</span> <span class="nx">bookRes</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
          <span class="nx">rp</span><span class="p">.</span><span class="kd">get</span><span class="p">({</span><span class="na">url</span><span class="p">:</span> <span class="nx">bundleUrl</span><span class="p">,</span> <span class="na">json</span><span class="p">:</span> <span class="kc">true</span><span class="p">}),</span>
          <span class="nx">rp</span><span class="p">.</span><span class="kd">get</span><span class="p">({</span><span class="na">url</span><span class="p">:</span> <span class="nx">bookUrl</span><span class="p">,</span> <span class="na">json</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
        <span class="p">]);</span>
        <span class="c1">// Extract bundle and book information from responses</span>
        <span class="kd">const</span> <span class="p">{</span> <span class="na">_source</span><span class="p">:</span> <span class="nx">bundle</span><span class="p">,</span> <span class="na">_version</span><span class="p">:</span> <span class="nx">version</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">bundleRes</span><span class="p">;</span>
        <span class="kd">const</span> <span class="p">{</span> <span class="na">_source</span><span class="p">:</span> <span class="nx">book</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">bookRes</span><span class="p">;</span>

        <span class="kd">const</span> <span class="nx">idx</span> <span class="o">=</span> <span class="nx">bundle</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">findIndex</span><span class="p">(</span><span class="nx">book</span> <span class="o">=&gt;</span> <span class="nx">book</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">pgid</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">idx</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">bundle</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
            <span class="na">id</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">pgid</span><span class="p">,</span>
            <span class="na">title</span><span class="p">:</span> <span class="nx">book</span><span class="p">.</span><span class="nx">title</span>
          <span class="p">});</span>
        <span class="p">}</span>

        <span class="c1">// Save the updated bundle</span>
        <span class="kd">const</span> <span class="nx">esResBody</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">rp</span><span class="p">.</span><span class="nx">put</span><span class="p">({</span>
          <span class="na">url</span><span class="p">:</span> <span class="nx">bundleUrl</span><span class="p">,</span>
          <span class="na">qs</span><span class="p">:</span> <span class="p">{</span> <span class="nx">version</span> <span class="p">},</span> <span class="c1">// qs stands for "query string". We pass the version number</span>
          <span class="cm">/* When ES receives the request it checks that its internal version number
          for this document  matches the qs param. If they don't match  it means the document
          changed somehow  and ES will send back a 409 conflict HTTP status code causing
          the await to throw an exception */</span>
          <span class="na">body</span><span class="p">:</span> <span class="nx">bundle</span><span class="p">,</span>
          <span class="na">json</span><span class="p">:</span> <span class="kc">true</span>
        <span class="p">});</span>

        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">esResBody</span><span class="p">);</span>

      <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">esResErr</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">esResErr</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">||</span> <span class="mi">502</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">esResErr</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre>[~/sol-nodejs-the-right-way(master)]$ curl -s -X PUT localhost:60702/api/bundle/$BUNDLE_ID/book/pg132 | jq .
{
  "_index": "b4",
  "_type": "bundle",
  "_id": "zLkMWmcB1uX03maR3vEQ",
  "_version": 4,
  "result": "updated",
  "_shards": {
    "total": 2,
    "successful": 1,
    "failed": 0
  },
  "_seq_no": 3,
  "_primary_term": 2
}
[~/sol-nodejs-the-right-way(master)]$ curl -s localhost:60702/api/bundle/$BUNDLE_ID | jq .
{
  "_index": "b4",
  "_type": "bundle",
  "_id": "zLkMWmcB1uX03maR3vEQ",
  "_version": 4,
  "found": true,
  "_source": {
    "name": "lectura ligera",
    "books": [
      {
        "id": "pg132",
        "title": "The Art of War"
      }
    ]
  }
}
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="wrapping-up">Wrapping Up</h2>

<h3 id="deleting-a-bundle-entirely">Deleting a Bundle Entirely</h3>

<ul>
  <li>Add an API to delete a bundle entirely. Fill the gaps:</li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="cm">/**
  * Delete a bundle entirely.
  * curl -X DELETE http://&lt;host&gt;:&lt;port&gt;/api/bundle/&lt;id&gt;
  */</span>
 <span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/bundle/:id</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="kd">const</span> <span class="nx">bundleUrl</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">url</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
   <span class="k">try</span> <span class="p">{</span>
     <span class="p">..</span>
   <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">esResErr</span><span class="p">)</span> <span class="p">{</span>
     <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">esResErr</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">||</span> <span class="mi">502</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">esResErr</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
   <span class="p">}</span>
 <span class="p">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="removing-a-book-from-a-bundle">Removing a Book from a Bundle</h3>

<p>Inside the <code class="language-plaintext highlighter-rouge">try</code> block you‚Äôll need to do a few things:</p>

<ol>
  <li>Use <code class="language-plaintext highlighter-rouge">await</code> with <code class="language-plaintext highlighter-rouge">rp</code> to retrieve the bundle object from Elasticsearch.</li>
  <li>Find the index of the book within the <code class="language-plaintext highlighter-rouge">bundle.books</code> list.</li>
  <li>Remove the book from the list</li>
  <li><code class="language-plaintext highlighter-rouge">PUT</code> the updated bundle object back into the Elasticsearch index</li>
</ol>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="cm">/**
  * Remove a book from a bundle.
  * curl -X DELETE http://&lt;host&gt;:&lt;port&gt;/api/bundle/&lt;id&gt;/book/&lt;pgid&gt;
  */</span>
 <span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/bundle/:id/book/:pgid</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="kd">const</span> <span class="nx">bundleUrl</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">url</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>

   <span class="k">try</span> <span class="p">{</span>
     <span class="p">...</span>
   <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">esResErr</span><span class="p">)</span> <span class="p">{</span>
     <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">esResErr</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">||</span> <span class="mi">502</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">esResErr</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
   <span class="p">}</span>
 <span class="p">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="peer-dependencies">Peer-dependencies</h2>

<ul>
  <li><a href="https://nodejs.org/en/blog/npm/peer-dependencies/">Peer Dependencies
by Domenic Denicola</a></li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>[~/local/src/CA/sol-nodejs-the-right-way/developing-restful-web-services-chapter-7/web-services/b4(master)]$ npm install request-promise
+ request-promise@4.2.2
added 4 packages from 2 contributors and audited 2821 packages in 7.391s
found 0 vulnerabilities
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="gulpfile-tasks">Gulpfile tasks</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
</pre></td><td class="rouge-code"><pre><span class="cm">/********************* CHAPTER 7 *********************/</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">"</span><span class="s2">c7-http-server</span><span class="dl">"</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`node developing-restful-web-services-chapter-7/web-services/server.js`</span>
<span class="p">));</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">"</span><span class="s2">c7-http-client</span><span class="dl">"</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`curl localhost:60700`</span>
<span class="p">));</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">"</span><span class="s2">c7-express-server</span><span class="dl">"</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`node developing-restful-web-services-chapter-7/web-services/hello/server.js`</span>
<span class="p">));</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">"</span><span class="s2">c7-express-client-verbose</span><span class="dl">"</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`curl -i localhost:60701/hello/ivan`</span>
<span class="p">));</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">"</span><span class="s2">c7-express-client</span><span class="dl">"</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`curl -s localhost:60701/hello/ivan | jq`</span>
<span class="p">));</span>

<span class="c1">// Server listening in port 60702</span>
<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">"</span><span class="s2">c7-b4-server</span><span class="dl">"</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`node developing-restful-web-services-chapter-7/web-services/b4/server.js`</span>
<span class="p">));</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">"</span><span class="s2">c7-b4-server-debug</span><span class="dl">"</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`node --inspect-brk developing-restful-web-services-chapter-7/web-services/b4/server.js`</span>
<span class="p">));</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">"</span><span class="s2">c7-b4-server-nodemon</span><span class="dl">"</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`nodemon developing-restful-web-services-chapter-7/web-services/b4/server.js`</span>
<span class="p">));</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">"</span><span class="s2">c7-get-shakespeare</span><span class="dl">"</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`curl -s localhost:60702/api/search/books/authors/Shakespeare | jq .[].title`</span>
<span class="p">));</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">"</span><span class="s2">c7-get-sawyer</span><span class="dl">"</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`curl -s localhost:60702/api/search/books/title/sawyer | jq .[].title`</span>
<span class="p">));</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">"</span><span class="s2">c7-suggest</span><span class="dl">"</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="c1">//`curl -s localhost:60702/api/suggest/authors/twayn | jq '.[].options[].text'`</span>
    <span class="s2">`curl -s localhost:60702/api/suggest/authors/twayn | jq '.'`</span>
<span class="p">));</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">"</span><span class="s2">c7-create-b4-index</span><span class="dl">"</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`commanding-databases-chapter-6/esclu/esclu create-index -i b4`</span>
<span class="p">));</span>

<span class="c1">// Communicate directly to es to create the bundle</span>
<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">"</span><span class="s2">c7-es-create-a-bundle</span><span class="dl">"</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`curl -H 'Content-Type: application/json' -X POST localhost:9200/b4/bundle -d '{"name":"nutrition","books":[]}'`</span>
    <span class="c1">// CKPgeWcB2Cwi_q-mx5lC</span>
<span class="p">));</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">"</span><span class="s2">c7-esclu-list</span><span class="dl">"</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s2">` echo "
   ./esclu li
   ./esclu get _search  | jq .
   ./esclu get '_search' | jq '.hits.hits[]._source' | head -n 20
   ./esclu get '_search/?q=authors:Twain' | jq '.' | head -n 30
   ./esclu get '_search?q=authors:Twain&amp;_source=title' | jq '.' | head -n 30
   ./esclu get '_search?q=authors:Twain&amp;_source=title' | jq '.hits.hits[]._source.title'
   ./esclu q authors:Twain AND subjects:children
   ./esclu q | jq '.' | head -n 30
   ./esclu q -f title,authors | jq '.' | head -n 30
   ./esclu q -f title,authors | jq '.hits.hits[]._source' | head -n 30
   ./esclu q authors:Shakespeare AND subjects:Drama -f title | jq '.hits.hits[]._source.title'
   ./esclu get pg132 --index books --type book | jq '.'
   ./esclu get pg132 -i books -t book | jq '._source' &gt; ../data/art_of_war.json
   ./esclu put ../data/art_of_war.json -i books -t book --id pg132 # Warning put
  "`</span>
<span class="p">));</span>

<span class="c1">// Get the bundle created by the former task</span>
<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">'</span><span class="s1">c7-request-es-bundle-by-id</span><span class="dl">'</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`BUNDLE_ID=CKPgeWcB2Cwi_q-mx5lC &amp;&amp; curl -s localhost:9200/b4/bundle/$BUNDLE_ID | jq .`</span>
<span class="p">));</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">'</span><span class="s1">c7-create-a-bundle</span><span class="dl">'</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`curl -s -X POST localhost:60702/api/bundle/?name=light%20reading | jq .`</span>
<span class="p">));</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">'</span><span class="s1">c7-bundle-id</span><span class="dl">'</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`BUNDLE_ID=zLkMWmcB1uX03maR3vEQ &amp;&amp; echo $BUNDLE_ID`</span>
<span class="p">));</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">'</span><span class="s1">c7-bundle-another-id</span><span class="dl">'</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`BUNDLE_ID=WpBEamcBVH6YJQy3-NQF &amp;&amp; echo $BUNDLE_ID`</span>
<span class="p">));</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">'</span><span class="s1">c7-request-bundle-by-id</span><span class="dl">'</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`BUNDLE_ID=zLkMWmcB1uX03maR3vEQ &amp;&amp; curl -s localhost:9200/b4/bundle/$BUNDLE_ID | jq .`</span>
<span class="p">));</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">'</span><span class="s1">c7-change-bundle-name</span><span class="dl">'</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`BUNDLE_ID=zLkMWmcB1uX03maR3vEQ &amp;&amp; curl -s -X PUT localhost:60702/api/bundle/$BUNDLE_ID/name/lectura%20ligera | jq .`</span>
<span class="p">));</span>

<span class="kd">const</span> <span class="nx">header</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">"Content-Type: application/json"</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">trimnl</span> <span class="o">=</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">\s</span><span class="sr">+/g</span><span class="p">,</span> <span class="dl">""</span><span class="p">);</span>

<span class="cm">/*
  We are adding now to the index named accounts
  a document of type person
  having the id 1;
  since the index does not exist yet, Elasticsearch will automatically create it.
*/</span>
<span class="kd">let</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">trimnl</span><span class="p">(</span><span class="s2">`
  {
        "size": 0,
        "suggest": {
                "suggestions": {
                        "text": "twayn",
                        "term": {
                                "field": "authors",
                                "suggest_mode": "always"
                        }
                }
        }
  }
`</span><span class="p">);</span>

<span class="cm">/*
console.log(request);
curl -X GET "localhost:9200/twitter/_search" -H 'Content-Type: application/json' -d'
{
    "query" : {
        "term" : { "user" : "kimchy" }
    }
}
'
*/</span>


<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">'</span><span class="s1">c7-es-suggest</span><span class="dl">'</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`curl -s  -H 'Content-Type: application/json' -d '</span><span class="p">${</span><span class="nx">request</span><span class="p">}</span><span class="s2">' -X GET localhost:9200/books/book/_search | jq .suggest.suggestions`</span>
<span class="p">));</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">'</span><span class="s1">c7-change-bundle-name-foo</span><span class="dl">'</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`BUNDLE_ID=zLkMWmcB1uX03maR3vEQ &amp;&amp; curl -s -X PUT localhost:60702/api/bundle/$BUNDLE_ID/name/foo | jq .`</span>
<span class="p">));</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">'</span><span class="s1">c7-insert-book-into-bundle</span><span class="dl">'</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`BUNDLE_ID=zLkMWmcB1uX03maR3vEQ &amp;&amp; curl -s -X PUT localhost:60702/api/bundle/$BUNDLE_ID/book/pg132 | jq .`</span>
<span class="p">));</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="dl">"</span><span class="s2">c7-b4-version</span><span class="dl">"</span><span class="p">,</span> <span class="nx">shell</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span>
    <span class="s2">`curl -s localhost:60702/api/version`</span>
<span class="p">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre>~/sol-nodejs-the-right-way<span class="o">(</span>master<span class="o">)]</span><span class="nv">$ </span>gulp <span class="nt">-T</span> | <span class="nb">grep </span>c7
<span class="o">[</span>12:58:56] ‚îú‚îÄ‚îÄ c7-http-server
<span class="o">[</span>12:58:56] ‚îú‚îÄ‚îÄ c7-http-client
<span class="o">[</span>12:58:56] ‚îú‚îÄ‚îÄ c7-express-server
<span class="o">[</span>12:58:56] ‚îú‚îÄ‚îÄ c7-express-client-verbose
<span class="o">[</span>12:58:56] ‚îú‚îÄ‚îÄ c7-express-client
<span class="o">[</span>12:58:56] ‚îú‚îÄ‚îÄ c7-b4-server
<span class="o">[</span>12:58:56] ‚îú‚îÄ‚îÄ c7-b4-server-debug
<span class="o">[</span>12:58:56] ‚îú‚îÄ‚îÄ c7-b4-server-nodemon
<span class="o">[</span>12:58:56] ‚îú‚îÄ‚îÄ c7-get-shakespeare
<span class="o">[</span>12:58:56] ‚îú‚îÄ‚îÄ c7-get-sawyer
<span class="o">[</span>12:58:56] ‚îú‚îÄ‚îÄ c7-suggest-lipman
<span class="o">[</span>12:58:56] ‚îú‚îÄ‚îÄ c7-create-b4-index
<span class="o">[</span>12:58:56] ‚îú‚îÄ‚îÄ c7-create-a-bundle
<span class="o">[</span>12:58:56] ‚îú‚îÄ‚îÄ c7-bundle-id
<span class="o">[</span>12:58:56] ‚îú‚îÄ‚îÄ c7-bundle-another-id
<span class="o">[</span>12:58:56] ‚îú‚îÄ‚îÄ c7-request-bundle-by-id
<span class="o">[</span>12:58:56] ‚îú‚îÄ‚îÄ c7-change-bundle-name
<span class="o">[</span>12:58:56] ‚îú‚îÄ‚îÄ c7-change-bundle-name-foo
<span class="o">[</span>12:58:56] ‚îú‚îÄ‚îÄ c7-insert-book-into-bundle
<span class="o">[</span>12:58:56] ‚îî‚îÄ‚îÄ c7-b4-version
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>Starting the Server</strong>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>gulp.task("c7-express-server", shell.task(
  `node developing-restful-web-services-chapter-7/web-services/hello/server.js`
));
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>[~/sol-nodejs-the-right-way(master)]$  gulp c7-express-server
[12:31:01] Using gulpfile ~/local/src/CA/sol-nodejs-the-right-way/gulpfile.js
[12:31:01] Starting 'c7-express-server'...
Listening on 60701
GET / 404 5.228 ms - 139
GET /hello/ivan 200 6.316 ms - 16
GET /hello/ivan 200 0.637 ms - 16
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="references">References</h2>

<ul>
  <li><a href="http://nodejs.org/api/http.html">http://nodejs.org/api/http.html</a></li>
  <li><a href="http://expressjs.com/">http://expressjs.com/</a></li>
  <li><a href="http://www.sinatrarb.com/">http://www.sinatrarb.com/</a></li>
  <li><a href="https://www.npmjs.com/package/nconf">https://www.npmjs.com/package/nconf</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.2/search-request-body.html">https://www.elastic.co/guide/en/elasticsearch/reference/5.2/search-request-body.html </a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.2/search-suggesters.html">https://www.elastic.co/guide/en/elasticsearch/reference/5.2/search-suggesters.html</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/search-suggesters.html">Elasticsearch Suggesters: The suggest feature suggests similar looking terms based on a provided text by using a suggester</a></li>
  <li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols</a></li>
  <li><a href="https://ull-mii-ca-1819.github.io/learning-js/_book/async-js/async-js.html">Apuntes del profesor en Async JS</a></li>
</ul>


            </div>
                        <details>
                <summary><h2>Comment with GitHub Utterances</h2></summary>
                <script src="https://utteranc.es/client.js"
        repo="ULL-MII-SYTWS-1920/ull-mii-sytws-1920.github.io"
        issue-term="pathname"
        label="SYTWS"
        theme="dark-blue"
        crossorigin="anonymous"
        async>
</script>
            </details>
            
            <details>
                <summary>
                   <h2>Comment with Disqus</h2> 
                </summary>              
                



<div id="disqus_thread">
    thread de discusion
</div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: 
EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: 
       https://disqus.com/admin/universalcode/#configuration-variables*/

/*
var disqus_config = function () {
   this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
   this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/

(function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://https-ull-mii-sytws-1920-github-io.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
   (d.head || d.body).appendChild(s);
})();

</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            

 

            </details>
        </section>
    
    </div>


    
</body>

</html>
