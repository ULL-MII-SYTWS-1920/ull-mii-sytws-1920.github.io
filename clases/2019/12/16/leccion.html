<!doctype html>
<html lang=" en-US ">

<head>
    <meta charset="utf-8">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=88e715cdd6e0bd047c7d68b39d123a466842e492">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="/assets/js/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="/assets/css/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

</head>

<body>
    <div id="header">
        <nav>
    <li><a href="/search" title="search">&#x1F50D;</a></li>
    <!--
    <li><a href="#sytwstoc" title="Table of Contents">‚â°</a></li>
    -->

    
    
    <li><a href="https://github.com/ULL-MII-SYTWS-1920/ull-mii-sytws-1920.github.io/tree/master//_posts/2019-12-16-leccion.md" title="Edit this page at GitHub">üêô</a>
    
    <li><a href="/references.html" title="Bibliograf√≠a">&#x1f4da</a></li>
    <li><a href="/practicas.html" title="Pr√°cticas">&#x270d</a></li>
    
    <li><a href="/clases.html" title="Clases">üë®‚Äçüè´</a></li>

    <li><a href="/" title="Home page">&#x1f3e0</a></li>
    <li><a href="/tema0-presentacion/" title="Tema 0: Presentaci√≥n">0</a></li>
    <li><a href="/tema1-introduccion/" title="Tema 1: Introducci√≥n">1</a></li>
    <li><a href="/tema2-async/" title="Tema 2: Async">2</a></li>
    <li><a href="/tema3-web/" title="Tema 3: Web">3</a></li>
    <li><a href="/tema4-devops/" title="Tema 4: Devop">4</a></li>
    
</nav>

    </div>
    <!-- end header -->


    <div class="wrapper">

        <section>
            
<div id="title">
        <h1>Sistemas y Tecnolog√≠as Web: Servidor</h1>
        <p> Master de II. ULL. 1er cuatrimestre. 2020/2021</p>
        <hr>
        <span class="credits left">Organization <a href="https://github.com/ULL-MII-SYTWS-2021" target="_blank">ULL-MII-SYTWS-2021</a></span>
        <span class="credits left"> &nbsp; Classroom <a href="https://classroom.github.com/classrooms/68184806-ull-mii-sytws-2021" target="_blank">ULL-MII-SYTWS-2021</a></span>
        <span class="credits left"> &nbsp; Campus Virtual <a href="https://campusdoctoradoyposgrado.ull.es/course/view.php?id=2020111300" target="_blank">SYTWS</a></span>
        <span class="credits left"> &nbsp; Chat <a href="https://chat.google.com/u/1/room/AAAAp18fCE8" target="_blank">Chat</a></span>
        <span class="credits left"> &nbsp; Profesor <a href="https://www.ull.es/apps/guias/guias/view_teacher_niu/745/(%3FPcrguezl.*)/" target="_blank">Casiano</a></span>
    </div>

<!--

<div id="title">
    <h1>Sistemas y Tecnolog√≠as Web: Servidor</h1>
    <p> Master de II. ULL. 1er cuatrimestre. 2020/2021</p>
    <hr>
    <span class="credits left">Organization <a href="https://github.com/ULL-MII-SYTWS-2021"
            target="_blank">ULL-MII-SYTWS-2021</a></span>
    <span class="credits left"> &nbsp; Github Classroom <a
            href="https://classroom.github.com/classrooms/55384072-master-de-ingenieria-informatica-sistemas-y-tecnologias-web-servidor-classroom"
            target="_blank">SYTWS 19/20</a></span>
    <span class="credits left"> &nbsp; Campus Virtual <a
            href="https://campusvirtual.ull.es/1920/course/view.php?id=201913778" target="_blank">SYTWS
            19/20</a></span>
    <span class="credits left"> &nbsp; Profesor <a
            href="https://www.ull.es/apps/guias/guias/view_teacher_niu/588/(%3FPcrguezl.*)/"" target="
            _blank">Casiano</a></span>
</div>
-->    

            
            



            <h2 >Table of Contents</h2>
            
            <ul id="sytwstoc">
  <li><a href="#clase-del-lunes-16122019">Clase del Lunes 16/12/2019</a>
    <ul>
      <li><a href="#final-de-curso">Final de Curso</a></li>
      <li><a href="#recapping-the-transforming-data-and-testing-continuously-lesson">Recapping the <em>Transforming Data and Testing Continuously</em> Lesson</a>
        <ul>
          <li><a href="#testparse-rdf-testjs"><a href="/test/parse-rdf-test.js">test/parse-rdf-test.js</a></a></li>
          <li><a href="#libparse-rdfjs"><a href="/lib/parse-rdf.js">lib/parse-rdf.js</a></a></li>
          <li><a href="#rdf-to-jsonjs"><a href="/rdf-to-json.js">rdf-to-json.js</a></a></li>
          <li><a href="#processing-data-files-sequentially">Processing Data Files Sequentially</a></li>
          <li><a href="#descripci√≥n-de-la-pr√°ctica-p9-t3-transforming-data-extracting-classification-codes-and-sources">Descripci√≥n de la pr√°ctica p9-t3-transforming-data: Extracting Classification Codes and Sources</a></li>
        </ul>
      </li>
      <li><a href="#el-reto-precios-de-hiperdino">El Reto: Precios de Hiperdino</a></li>
    </ul>
  </li>
</ul>
          

            <div class="container">
                <h1 id="clase-del-lunes-16122019">Clase del Lunes 16/12/2019</h1>

<h2 id="final-de-curso">Final de Curso</h2>

<ul>
  <li><a href="https://drive.google.com/file/d/1EBVRMo7LwDQYdQ4-d7Pbzw84XQeqIa-C/view">Descripci√≥n del calendario</a></li>
  <li>Entiendo que las clases se acaban el 17/01/2019</li>
  <li>Los ex√°menes aparece del 20/01 al 01/02. Los de la Web ULL no han actualizado el enlace, pero es este:
    <ul>
      <li><a href="https://docs.google.com/document/d/1L1vcYHPtowuP_v-1HLMtJms7S_efD3jHt9H4zrND1IU/edit">Ex√°menes de la Convocatoria de Enero</a></li>
      <li>Enero:
        <ul>
          <li>24/1/2020</li>
          <li>16:00</li>
          <li>2.2</li>
          <li>31/1/2020</li>
          <li>16:00</li>
          <li>2.2</li>
        </ul>
      </li>
      <li>Junio
        <ul>
          <li>3/7/2020</li>
          <li>16:00</li>
          <li>2.2</li>
        </ul>
      </li>
      <li>Septiembre
        <ul>
          <li>4/9/2020</li>
          <li>16:00</li>
          <li>2.2</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Cierre de actas: Viernes 7 de Febrero de 2020</li>
  <li>Hemos a√±adido una pr√°ctica nueva y el Trabajo Fin de Asignatura
    <ul>
      <li><a href="/tema3-web/practicas/p11-t3-restful/">p11-t3-restful</a></li>
      <li><a href="/tema3-web/practicas/p12-tfa-user-experience/">p12-tfa-user-experience</a></li>
    </ul>
  </li>
  <li>Pueden encontrar las soluciones a las pr√°cticas del autor del libro en este repo <a href="https://github.com/ULL-MII-SYTWS-1920/book-solution-nodejs-the-right-way">ULL-MII-SYTWS-1920/book-solution-nodejs-the-right-way</a>. Deber√≠a tener permisos de acceso</li>
  <li>Para cada convocatoria, las pr√°cticas deber√≠an estar entregadas en su mayor√≠a 5 d√≠as antes antes de los cierres de actas, que son estos d√≠as:
    <ul>
      <li>Viernes 14 de Febrero 2020</li>
      <li>Viernes 27 de Marzo 2020</li>
      <li>Jueves 25 de Junio 2020</li>
      <li>Mi√©rcoles 22 de Julio 2020</li>
      <li>Jueves 25 de Septiembre 2020</li>
    </ul>
  </li>
</ul>

<style>
table, td, th {  
  border: 1px solid #ddd;
  text-align: left;
}

table {
  border-collapse: collapse;
  width: 60%;
}

th, td {
  padding: 1px;
}
</style>

<table>
  <tr>
    <td>
    <img alt="/assets/images/enero2020.png" src="/assets/images/enero2020.png" />
    </td>
    <td>
    <img src="/assets/images/instrucciones-calendario.png" />
    </td>
  </tr>
</table>

<h2 id="recapping-the-transforming-data-and-testing-continuously-lesson">Recapping the <em>Transforming Data and Testing Continuously</em> Lesson</h2>

<h3 id="testparse-rdf-testjs"><a href="/test/parse-rdf-test.js">test/parse-rdf-test.js</a></h3>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="err">‚Äã</span> <span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">expect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">chai</span><span class="dl">'</span><span class="p">).</span><span class="nx">expect</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">parseRDF</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../lib/parse-rdf.js</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">rdf</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">__dirname</span><span class="p">}</span><span class="s2">/pg132.rdf`</span><span class="p">);</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">Chapter 5: Transforming Data and Testing Continuously</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">parseRDF</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should be a function</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">debugger</span><span class="p">;</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">parseRDF</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">a</span><span class="p">(</span><span class="dl">'</span><span class="s1">function</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should parse RDF content</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">book</span> <span class="o">=</span> <span class="nx">parseRDF</span><span class="p">(</span><span class="nx">rdf</span><span class="p">);</span>
      <span class="c1">// https://www.chaijs.com/api/bdd/#method_language-chains</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">book</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">a</span><span class="p">(</span><span class="dl">'</span><span class="s1">object</span><span class="dl">'</span><span class="p">);</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">book</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">,</span> <span class="mi">132</span><span class="p">);</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">book</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">title</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">The Art of War</span><span class="dl">'</span><span class="p">);</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">book</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">authors</span><span class="dl">'</span><span class="p">).</span><span class="nx">that</span><span class="p">.</span><span class="nx">is</span><span class="p">.</span><span class="nx">an</span><span class="p">(</span><span class="dl">'</span><span class="s1">array</span><span class="dl">'</span><span class="p">).</span><span class="kd">with</span><span class="p">.</span><span class="nx">lengthOf</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span>
      <span class="nx">and</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="dl">'</span><span class="s1">Sunzi, active 6th century B.C.</span><span class="dl">'</span><span class="p">).</span>
      <span class="nx">and</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="dl">'</span><span class="s1">Giles, Lionel</span><span class="dl">'</span><span class="p">);</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">book</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">subjects</span><span class="dl">'</span><span class="p">).</span><span class="nx">that</span><span class="p">.</span><span class="nx">is</span><span class="p">.</span><span class="nx">an</span><span class="p">(</span><span class="dl">'</span><span class="s1">array</span><span class="dl">'</span><span class="p">).</span><span class="kd">with</span><span class="p">.</span><span class="nx">lengthOf</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span>
      <span class="nx">and</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="dl">'</span><span class="s1">Military art and science -- Early works to 1800</span><span class="dl">'</span><span class="p">).</span>
      <span class="nx">and</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="dl">'</span><span class="s1">War -- Early works to 1800</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="libparse-rdfjs"><a href="/lib/parse-rdf.js">lib/parse-rdf.js</a></h3>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">cheerio</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">cheerio</span><span class="dl">"</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">rdf</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">$</span> <span class="o">=</span> <span class="nx">cheerio</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">rdf</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">book</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="cm">/* We're trying to grab the number 132  out of this XML tag:
    &lt;pgterms:ebook rdf:about="ebooks/132"&gt;
  */</span>
  <span class="nx">book</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="o">+</span>  <span class="c1">// Convert to a number</span>
     <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">pgterms</span><span class="se">\\</span><span class="s1">:ebook</span><span class="dl">'</span><span class="p">)</span> <span class="c1">// In CSS, the colon : is used for pseudo selectors (like :hover) that is why we have to escape it</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">'</span><span class="s1">rdf:about</span><span class="dl">'</span><span class="p">)</span> <span class="c1">// get the rdf:about attribute</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="dl">'</span><span class="s1">ebooks/</span><span class="dl">'</span><span class="p">,</span><span class="dl">''</span><span class="p">);</span>
  <span class="c1">// Find   &lt;dcterms:title&gt;The Art of War&lt;/dcterms:title&gt;</span>
  <span class="nx">book</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">dcterms</span><span class="se">\\</span><span class="s1">:title</span><span class="dl">'</span><span class="p">).</span><span class="nx">text</span><span class="p">();</span>

  <span class="nx">book</span><span class="p">.</span><span class="nx">authors</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">pgterms</span><span class="se">\\</span><span class="s1">:agent pgterms</span><span class="se">\\</span><span class="s1">:name</span><span class="dl">'</span><span class="p">)</span>
                 <span class="p">.</span><span class="nx">toArray</span><span class="p">()</span> <span class="c1">// The collection object returned is not a true Array we have to convert it</span>
                 <span class="p">.</span><span class="nx">map</span><span class="p">(</span>
                   <span class="p">(</span><span class="nx">e</span><span class="p">)</span>  <span class="o">=&gt;</span> <span class="p">{</span> <span class="c1">// e is a document node has no text method</span>
                             <span class="c1">// that is why we wrap it $(e) to a cheerio object</span>
                     <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">).</span><span class="nx">text</span><span class="p">();</span>
                   <span class="p">}</span>
                 <span class="p">);</span>


  <span class="nx">book</span><span class="p">.</span><span class="nx">subjects</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">[rdf</span><span class="se">\\</span><span class="s1">:resource$="/LCSH"]</span><span class="dl">'</span><span class="p">).</span>
                  <span class="nx">parent</span><span class="p">()</span> <span class="c1">// https://api.jquery.com/parent/</span>
                  <span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="dl">'</span><span class="s1">rdf</span><span class="se">\\</span><span class="s1">:value</span><span class="dl">'</span><span class="p">)</span> <span class="c1">// https://api.jquery.com/find/</span>
                  <span class="p">.</span><span class="nx">toArray</span><span class="p">()</span>
                  <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">).</span><span class="nx">text</span><span class="p">());</span>
  <span class="k">return</span> <span class="nx">book</span><span class="p">;</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Using this, we can now quickly put together a command-line program to explore some of the other RDF files. Open your editor and enter this:</p>

<h3 id="rdf-to-jsonjs"><a href="/rdf-to-json.js">rdf-to-json.js</a></h3>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="cp">#!/usr/bin/env node
</span><span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">parseRDF</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./lib/parse-rdf.js</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">rdf</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="kd">const</span> <span class="nx">book</span> <span class="o">=</span> <span class="nx">parseRDF</span><span class="p">(</span><span class="nx">rdf</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">book</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="dl">'</span><span class="s1">  </span><span class="dl">'</span><span class="p">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>When calling <a href="https://developer.mozilla.org/es/docs/Web/JavaScript/Referencia/Objetos_globales/JSON/stringify"><code class="language-plaintext highlighter-rouge">JSON.stringify</code></a> we‚Äôre passing three arguments:</p>
<ol>
  <li>The second argument (<code class="language-plaintext highlighter-rouge">null</code>) is an optional replacer function that can be used for filtering</li>
  <li>The last argument (<code class="language-plaintext highlighter-rouge">' '</code>) is used to indent nested objects, making the output more human-readable.</li>
</ol>

<p>Let‚Äôs open a terminal in our databases project directory and run it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>[~/local/src/CA/sol-nodejs-the-right-way/transforming-data-and-testing-continuously-chapter-5(master)]$ cd databases/
[~/local/src/CA/sol-nodejs-the-right-way/transforming-data-and-testing-continuously-chapter-5/databases(master)]$ ls -l rdf-to-json.js 
-rw-r--r--  1 casiano  staff  217  7 nov 13:36 rdf-to-json.js
[~/local/src/CA/sol-nodejs-the-right-way/transforming-data-and-testing-continuously-chapter-5/databases(master)]$ chmod a+x rdf-to-json.js 
[~/local/src/CA/sol-nodejs-the-right-way/transforming-data-and-testing-continuously-chapter-5/databases(master)]$ ls -l rdf-to-json.js 
-rwxr-xr-x  1 casiano  staff  217  7 nov 13:36 rdf-to-json.js
[~/local/src/CA/sol-nodejs-the-right-way/transforming-data-and-testing-continuously-chapter-5/databases(master)]$ ./rdf-to-json.js ../data/cache/epub//11/pg11.rdf 
{
  "id": 11,
  "title": "Alice's Adventures in Wonderland",
  "authors": [
    "Carroll, Lewis"
  ],
  "subjects": [
    "Fantasy literature"
  ]
}
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="processing-data-files-sequentially">Processing Data Files Sequentially</h3>

<p>Our <a href="/lib/parse-rdf.js">lib/parse-rdf.js</a>  converts RDF content into JSON documents.</p>

<p>All that remains is to walk through the Project Gutenberg catalog directory and collect all the JSON documents.</p>

<p>More concretely, we need to do the following:</p>

<ol>
  <li>Traverse down the <code class="language-plaintext highlighter-rouge">data/cache/epub</code> directory looking for files ending in <code class="language-plaintext highlighter-rouge">rdf</code>.</li>
  <li>Read each RDF file.</li>
  <li>Run the RDF content through <code class="language-plaintext highlighter-rouge">parseRDF</code>.</li>
  <li>Collect the JSON serialized objects into a single, bulk file for insertion.</li>
</ol>

<p>The NoSQL database we‚Äôll be using is Elasticsearch, a document datastore that indexes JSON objects.</p>

<p><strong>GOAL</strong>: We want to transform the Gutenberg data into an intermediate form for bulk import.</p>

<p><a href="https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/current/api-reference.html">Elasticsearch has a bulk-import API that lets you pull in many records at once</a></p>

<p>Although we could insert them one at a time, it is significantly faster to use the bulk-insert API.</p>

<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html">The format of the file we need to create is described on Elasticsearch‚Äôs Bulk API page</a></p>

<p>It‚Äôs an LDJ file consisting of</p>
<ol>
  <li><strong>actions</strong> and</li>
  <li>the <strong>source objects on which to perform each action</strong>.</li>
</ol>

<p>In our case, we‚Äôre performing <code class="language-plaintext highlighter-rouge">index</code> operations‚Äîthat is, 
<strong>inserting new documents into an index</strong>.</p>

<p>Each source object is the book object returned by <code class="language-plaintext highlighter-rouge">parseRDF</code>.
Here‚Äôs an example of an action followed by its source object:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>‚Äã  {‚Äã"index"‚Äã:{‚Äã"_id"‚Äã:‚Äã"pg11"‚Äã}}
‚Äã  {‚Äã"id"‚Äã:11,‚Äã"title"‚Äã:‚Äã"Alice's Adventures in Wonderland"‚Äã,‚Äã"authors"‚Äã:...}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>And here‚Äôs another one:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>‚Äã   {‚Äã"index"‚Äã:{‚Äã"_id"‚Äã:‚Äã"pg132"‚Äã}}
‚Äã   {‚Äã"id"‚Äã:132,‚Äã"title"‚Äã:‚Äã"The Art of War"‚Äã,‚Äã"authors"‚Äã:...}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>In each case,</p>
<ol>
  <li>an action is a JSON object on a line by itself, and</li>
  <li>the source object is another JSON object on the next line.</li>
</ol>

<p>Elasticsearch‚Äôs bulk API allows you to chain any number of these together like so:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>  {‚Äã"index"‚Äã:{‚Äã"_id"‚Äã:‚Äã"pg11"‚Äã}}
‚Äã  {‚Äã"id"‚Äã:11,‚Äã"title"‚Äã:‚Äã"Alice's Adventures in Wonderland"‚Äã,‚Äã"authors"‚Äã:...}
‚Äã  {‚Äã"index"‚Äã:{‚Äã"_id"‚Äã:‚Äã"pg132"‚Äã}}
‚Äã  {‚Äã"id"‚Äã:132,‚Äã"title"‚Äã:‚Äã"The Art of War"‚Äã,‚Äã"authors"‚Äã:...}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>To find and open each of the <code class="language-plaintext highlighter-rouge">RDF</code> files under the <code class="language-plaintext highlighter-rouge">data/cache/epub</code> directory, we will use a module called <a href="https://github.com/fshost/node-dir">node-dir</a>.</p>

<p>Install it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>‚Äã‚Äã$ ‚Äã‚Äãnpm‚Äã‚Äã ‚Äã‚Äãinstall‚Äã‚Äã ‚Äã‚Äã‚Äã‚Äãnode-dir
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This module comes with a handful of useful methods for walking a directory tree.</p>

<p>The method we‚Äôll use is 
<code class="language-plaintext highlighter-rouge">readFiles</code>, 
which sequentially operates on files as it encounters them while walking a directory tree.</p>
<details>
 <summary>
 <b>Argumentos de readFiles</b>
 </summary>
  <ul>
    <li>encoding: file encoding (defaults to 'utf8')</li>
    <li>exclude: a regex pattern or array to specify filenames to ignore</li>
    <li>excludeDir: a regex pattern or array to specify directories to ignore</li>
    <li>match: a regex pattern or array to specify filenames to operate on</li>
    <li>matchDir: a regex pattern or array to specify directories to recurse</li>
    <li>recursive: whether to recurse subdirectories when reading files (defaults to true)</li>
    <li>reverse: sort files in each directory in descending order</li>
    <li>shortName: whether to aggregate only the base filename rather than the full filepath</li>
    <li>sort: sort files in each directory in ascending order (defaults to true)</li>
    <li>doneOnErr: control if done function called on error (defaults to true)</li>
  </ul>
</details>

<p><strong><a href="/rdf-to-bulk.js">rdf-to-bulk</a></strong></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="c1">// Run as:</span>
<span class="c1">//          node rdf-to-bulk.js ../data/cache/epub | head</span>
<span class="c1">// or       gulp c5-rdf-to-json-11</span>
<span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">dir</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">node-dir</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">parseRDF</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__dirname</span><span class="o">+</span><span class="dl">'</span><span class="s1">/lib/parse-rdf.js</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">dirname</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">match</span><span class="p">:</span> <span class="sr">/</span><span class="se">\.</span><span class="sr">rdf$/</span><span class="p">,</span>
  <span class="na">exclude</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">pg0.rdf</span><span class="dl">'</span><span class="p">]</span>
<span class="p">};</span>

<span class="c1">// Because the head command closes the pipe after echoing the beginning lines</span>
<span class="c1">// we capture error events on the process.stdout stream</span>
<span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">,</span> <span class="nx">err</span> <span class="o">=&gt;</span> <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">());</span>

<span class="nx">dir</span><span class="p">.</span><span class="nx">readFiles</span><span class="p">(</span><span class="nx">dirname</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">parseRDF</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="na">index</span><span class="p">:</span> <span class="p">{</span> <span class="na">_id</span><span class="p">:</span> <span class="s2">`pg</span><span class="p">${</span><span class="nx">doc</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">}</span> <span class="p">}));</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">doc</span><span class="p">));</span>
  <span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">_id</code> field of each index operation is the unique identifier that Elasticsearch will use for the document.</p>

<p>Here the author has chosen to use the string <code class="language-plaintext highlighter-rouge">pg</code> followed by the Project Gutenberg ID. This way, if we ever wanted to store documents from another source in the same index, they shouldn‚Äôt collide with the Project Gutenberg book data.</p>

<p>Run the program like that:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>~/local/src/CA/sol-nodejs-the-right-way/transforming-data-and-testing-continuously-chapter-5/databases(master)]$ node rdf-to-bulk.js ../data/cache/epub | head
{"index":{"_id":"pg1"}}
{"id":1,"title":"The Declaration of Independence of the United States of America","authors":["Jefferson, Thomas"],"subjects":["United States -- History -- Revolution, 1775-1783 -- Sources","United States. Declaration of Independence"]}
{"index":{"_id":"pg10"}}
{"id":10,"title":"The King James Version of the Bible","authors":[],"subjects":["Bible"]}
{"index":{"_id":"pg100"}}
{"id":100,"title":"The Complete Works of William Shakespeare","authors":["Shakespeare, William"],"subjects":["English drama -- Early modern and Elizabethan, 1500-1600"]}
{"index":{"_id":"pg1000"}}
{"id":1000,"title":"La Divina Commedia di Dante: Complete","authors":["Dante Alighieri"],"subjects":[]}
{"index":{"_id":"pg10000"}}
{"id":10000,"title":"The Magna Carta","authors":["Anonymous"],"subjects":["Constitutional history -- England -- Sources","Magna Carta"]}
[~/local/src/CA/sol-nodejs-the-right-way/transforming-data-and-testing-continuously-chapter-5/databases(master)]$ 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Because the head command closes the pipe after echoing the beginning lines, this can sometimes cause Node.js to throw an exception.
We can capture error events on the <code class="language-plaintext highlighter-rouge">process.stdout</code> stream. That is why we have added  the following line to <code class="language-plaintext highlighter-rouge">rdf-to-bulk.js</code>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="err">‚Äã</span> 	<span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="err">‚Äã</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="err">‚Äã</span><span class="p">,</span> <span class="nx">err</span> <span class="o">=&gt;</span> <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">());</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Use the following command to capture the output in a new file called <code class="language-plaintext highlighter-rouge">bulk_pg.ldj</code>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre> ‚Äã‚Äãnode‚Äã‚Äã ‚Äã‚Äãrdf-to-bulk.js‚Äã‚Äã ‚Äã‚Äã../data/cache/epub/‚Äã‚Äã ‚Äã‚Äã&gt;‚Äã‚Äã ‚Äã‚Äã../data/bulk_pg.ldj‚Äã
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Esto lleva su tiempo, en mi m√°quina ocupa mas de 12MB:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>$ ls -lh data/
total 46664
-rw-r--r--  1 casiano  staff   294B 29 oct  2018 README.md
-rw-r--r--  1 casiano  staff    12M 11 mar  2019 bulk_pg.ldj
-rw-r--r--  1 casiano  staff    10M 20 nov  2018 bulk_result.json
drwxr-xr-x  3 casiano  staff    96B 25 oct  2018 cache
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="descripci√≥n-de-la-pr√°ctica-p9-t3-transforming-data-extracting-classification-codes-and-sources">Descripci√≥n de la pr√°ctica p9-t3-transforming-data: Extracting Classification Codes and Sources</h3>

<ul>
  <li><a href="/tema3-web/practicas/p9-t3-transforming-data/">La pr√°ctica p9-t3-transforming-data</a></li>
</ul>

<h2 id="el-reto-precios-de-hiperdino">El Reto: Precios de Hiperdino</h2>

<ul>
  <li><a href="/tema3-web/practicas/p9-t3-transforming-data/reto">Escriba un programa que liste los precios de Hiperdino por categor√≠a del producto</a></li>
</ul>

            </div>
                        <details>
                <summary><h2>Comment with GitHub Utterances</h2></summary>
                <script src="https://utteranc.es/client.js"
        repo="ULL-MII-SYTWS-1920/ull-mii-sytws-1920.github.io"
        issue-term="pathname"
        label="SYTWS"
        theme="dark-blue"
        crossorigin="anonymous"
        async>
</script>
            </details>
            
            <details>
                <summary>
                   <h2>Comment with Disqus</h2> 
                </summary>              
                



<div id="disqus_thread">
    thread de discusion
</div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: 
EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: 
       https://disqus.com/admin/universalcode/#configuration-variables*/

/*
var disqus_config = function () {
   this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
   this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/

(function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://https-ull-mii-sytws-1920-github-io.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
   (d.head || d.body).appendChild(s);
})();

</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            

 

            </details>
        </section>
    
    </div>


    
</body>

</html>
