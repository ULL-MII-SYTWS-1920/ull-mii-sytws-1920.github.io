<!doctype html>
<html lang=" en-US ">

<head>
    <meta charset="utf-8">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=a8db9f5ed3bfce1c7849f44f99b16371e6a97696">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="/assets/js/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="/assets/css/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

</head>

<body>
    <div id="header">
        <nav>
    <li><a href="/search" title="search">&#x1F50D;</a></li>
    <!--
    <li><a href="#sytwstoc" title="Table of Contents">‚â°</a></li>
    -->

    
    
    <li><a href="https://github.com/ULL-MII-SYTWS-1920/ull-mii-sytws-1920.github.io/tree/master//_posts/2019-11-25-leccion.md" title="Edit this page at GitHub">üêô</a>
    
    <li><a href="/references.html" title="Bibliograf√≠a">&#x1f4da</a></li>
    <li><a href="/practicas.html" title="Pr√°cticas">&#x270d</a></li>
    
    <li><a href="/clases.html" title="Clases">üë®‚Äçüè´</a></li>

    <li><a href="/" title="Home page">&#x1f3e0</a></li>
    <li><a href="/tema0-presentacion/" title="Tema 0: Presentaci√≥n">0</a></li>
    <li><a href="/tema1-introduccion/" title="Tema 1: Introducci√≥n">1</a></li>
    <li><a href="/tema2-async/" title="Tema 2: Async">2</a></li>
    <li><a href="/tema3-web/" title="Tema 3: Web">3</a></li>
    <li><a href="/tema4-devops/" title="Tema 4: Devop">4</a></li>
    
</nav>

    </div>
    <!-- end header -->


    <div class="wrapper">

        <section>
            
<div id="title">
        <h1>Sistemas y Tecnolog√≠as Web: Servidor</h1>
        <p> Master de II. ULL. 1er cuatrimestre. 2020/2021</p>
        <hr>
        <span class="credits left">Organization <a href="https://github.com/ULL-MII-SYTWS-2021" target="_blank">ULL-MII-SYTWS-2021</a></span>
        <span class="credits left"> &nbsp; Classroom <a href="https://classroom.github.com/classrooms/68184806-ull-mii-sytws-2021" target="_blank">ULL-MII-SYTWS-2021</a></span>
        <span class="credits left"> &nbsp; Campus Virtual <a href="https://campusdoctoradoyposgrado.ull.es/course/view.php?id=2020111300" target="_blank">SYTWS</a></span>
        <span class="credits left"> &nbsp; Chat <a href="https://chat.google.com/u/1/room/AAAAp18fCE8" target="_blank">Chat</a></span>
        <span class="credits left"> &nbsp; Profesor <a href="https://www.ull.es/apps/guias/guias/view_teacher_niu/745/(%3FPcrguezl.*)/" target="_blank">Casiano</a></span>
    </div>

<!--

<div id="title">
    <h1>Sistemas y Tecnolog√≠as Web: Servidor</h1>
    <p> Master de II. ULL. 1er cuatrimestre. 2020/2021</p>
    <hr>
    <span class="credits left">Organization <a href="https://github.com/ULL-MII-SYTWS"
            target="_blank">ULL-MII-SYTWS</a></span>
    <span class="credits left"> &nbsp; Github Classroom <a
            href="https://classroom.github.com/classrooms/55384072-master-de-ingenieria-informatica-sistemas-y-tecnologias-web-servidor-classroom"
            target="_blank">SYTWS 19/20</a></span>
    <span class="credits left"> &nbsp; Campus Virtual <a
            href="https://campusvirtual.ull.es/1920/course/view.php?id=201913778" target="_blank">SYTWS
            19/20</a></span>
    <span class="credits left"> &nbsp; Profesor <a
            href="https://www.ull.es/apps/guias/guias/view_teacher_niu/588/(%3FPcrguezl.*)/"" target="
            _blank">Casiano</a></span>
</div>
-->    

            
            



            <h2 >Table of Contents</h2>
            
            <ul id="sytwstoc">
  <li><a href="#clase-del-lunes-25112019">Clase del Lunes 25/11/2019</a>
    <ul>
      <li><a href="#chapter-20-of-eloquent-js">Chapter 20 of Eloquent JS</a>
        <ul>
          <li><a href="#idempotent-rest-apis">Idempotent REST APIs</a></li>
          <li><a href="#status">STATUS</a></li>
          <li><a href="#gulp-a-tool-to-automate-and-enhance-your-workflow">Gulp: a tool to Automate and Enhance your Workflow</a></li>
        </ul>
      </li>
      <li><a href="#jam-stack"><a href="/tema3-web/jam">JAM Stack</a></a>
        <ul>
          <li><a href="#jekyll">Jekyll</a></li>
          <li><a href="#jekyll-en-tu-m√°quina">Jekyll en tu m√°quina</a></li>
          <li><a href="#gastby"><a href="gatsby">Gastby</a></a></li>
        </ul>
      </li>
      <li><a href="#chapter-3-networking-with-sockets">Chapter 3: Networking with Sockets</a>
        <ul>
          <li><a href="#la-librer√≠a-libldj-clientjs">La Librer√≠a: lib/ldj-client.js</a></li>
          <li><a href="#el-cliente">El cliente</a></li>
          <li><a href="#servidor">Servidor</a></li>
          <li><a href="#running-server-and-client">Running Server and Client</a></li>
        </ul>
      </li>
      <li><a href="#the-observer-pattern">The Observer Pattern</a></li>
      <li><a href="#resources-and-references-for-this-lesson">Resources and References for this Lesson</a></li>
    </ul>
  </li>
</ul>
          

            <div class="container">
                <h1 id="clase-del-lunes-25112019">Clase del Lunes 25/11/2019</h1>

<h2 id="chapter-20-of-eloquent-js">Chapter 20 of Eloquent JS</h2>

<ul>
  <li><a href="https://eloquentjavascript.net/20_node.htm">Chapter 20: Node.js</a></li>
  <li><a href="/tema1-introduccion/practicas/p3-t1-c3-http/">Descripci√≥n de la Pr√°ctica http</a></li>
</ul>

<h3 id="idempotent-rest-apis">Idempotent REST APIs</h3>

<ul>
  <li>A Web service is defined as <em>a software system designed to support interoperable machine-to-machine interaction over a network</em>. 
Web services are frequently just Web APIs that can be accessed over a network, such as the Internet, and executed on a remote system hosting the requested services.</li>
  <li>
    <p>Representational state transfer (REST) is a software architectural style that <em>defines a set of constraints to be used for creating Web services</em>.</p>
  </li>
  <li><a href="https://restfulapi.net/idempotent-rest-apis">Idempotent REST APIs</a></li>
</ul>

<blockquote>
  <p>When you design REST APIs, you must realize that API consumers can make mistakes. They can write client code in such a way that there can be duplicate requests as well. These duplicate requests may be unintentional as well as intentional some time (e.g. due to timeout or network issues). You have to design fault-tolerant APIs in such a way that duplicate requests do not leave the system unstable.</p>
</blockquote>

<p>See also <a href="http://restcookbook.com/HTTP%20Methods/idempotency/">What are idempotent and/or safe methods?</a> del libro <a href="http://restcookbook.com/">restcookbook.com/</a></p>

<p><strong>Safe methods</strong> are methods that can be cached, prefetched without any repercussions to the resource.</p>

<p><strong>HTTP POST</strong></p>

<p>Generally ‚Äì not necessarily ‚Äì <code class="language-plaintext highlighter-rouge">POST</code> APIs are used to <strong>create</strong> a new resource on server. So when you invoke the same POST request <code class="language-plaintext highlighter-rouge">N</code> times, you will have <code class="language-plaintext highlighter-rouge">N</code> new resources on the server. So, <em><code class="language-plaintext highlighter-rouge">POST</code> is not idempotent</em>.</p>

<p><strong>HTTP PUT</strong></p>

<p>Generally ‚Äì not necessarily ‚Äì <code class="language-plaintext highlighter-rouge">PUT</code> APIs are used to <strong>update</strong> the resource state. If you invoke a <code class="language-plaintext highlighter-rouge">PUT</code> API <code class="language-plaintext highlighter-rouge">N</code> times, the very first request will update the resource; then rest <code class="language-plaintext highlighter-rouge">N-1</code> requests will just overwrite the same resource state again and again ‚Äì effectively not changing anything. Hence, <em><code class="language-plaintext highlighter-rouge">PUT</code> is idempotent</em>.</p>

<p>Recuerda la definici√≥n de idempotente:</p>

<blockquote>
  <p>when making <strong>multiple identical requests</strong> has the same effect as making a single request</p>
</blockquote>

<p>Si el request es <strong>id√©ntico el fichero</strong> y el <strong>nombre del fichero</strong> el estado del servidor no cambiar√° en los subsiguientes requests.</p>

<p>Si hubieramos hecho una implementaci√≥n que creara un fichero nuevo con cada request
(por ejemplo a√±adiendo un sufijo <code class="language-plaintext highlighter-rouge">.1</code>, <code class="language-plaintext highlighter-rouge">.2</code>, etc. al nombre del fichero por cada request)
nuestra implementaci√≥n de  <code class="language-plaintext highlighter-rouge">PUT</code> dejar√≠a de ser idempotente.</p>

<p><strong>HTTP DELETE</strong></p>

<p>When you invoke <code class="language-plaintext highlighter-rouge">N</code> similar <code class="language-plaintext highlighter-rouge">DELETE</code> requests, first request will delete the resource and response will be <code class="language-plaintext highlighter-rouge">200</code> (OK) or <code class="language-plaintext highlighter-rouge">204</code> (<code class="language-plaintext highlighter-rouge">No Content</code>). Other <code class="language-plaintext highlighter-rouge">N-1</code> requests will return <code class="language-plaintext highlighter-rouge">404</code> (<code class="language-plaintext highlighter-rouge">Not Found</code>).</p>

<p>Clearly, the response is different from first request, <strong>but there is no change of state for any resource</strong> on server side because original resource is already deleted. So, <em><code class="language-plaintext highlighter-rouge">DELETE</code> is idempotent</em>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="p">{</span><span class="nx">rmdir</span><span class="p">,</span> <span class="nx">unlink</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">fs</span><span class="dl">"</span><span class="p">).</span><span class="nx">promises</span><span class="p">;</span>

<span class="nx">methods</span><span class="p">.</span><span class="nx">DELETE</span> <span class="o">=</span> <span class="k">async</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">urlPath</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">stats</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">stats</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">stat</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span> <span class="o">!=</span> <span class="dl">"</span><span class="s2">ENOENT</span><span class="dl">"</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">return</span> <span class="p">{</span><span class="na">status</span><span class="p">:</span> <span class="mi">204</span><span class="p">};</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">stats</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">())</span> <span class="k">await</span> <span class="nx">rmdir</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
  <span class="k">else</span> <span class="k">await</span> <span class="nx">unlink</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">{</span><span class="na">status</span><span class="p">:</span> <span class="mi">204</span><span class="p">};</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Please keep in mind if some systems may have <code class="language-plaintext highlighter-rouge">DELETE</code> APIs like this:</p>

<p><strong>DELETE /item/last</strong></p>

<p>In the above case, calling operation <code class="language-plaintext highlighter-rouge">N</code> times will delete <code class="language-plaintext highlighter-rouge">N</code> resources ‚Äì hence <code class="language-plaintext highlighter-rouge">DELETE</code> is not idempotent in this case. In this case, a suggestion might be to change above API to <code class="language-plaintext highlighter-rouge">POST</code> ‚Äì because <code class="language-plaintext highlighter-rouge">POST</code> is not idempotent.</p>

<p><strong>POST /item/last</strong></p>

<p>Now, this is closer to HTTP spec ‚Äì hence more REST compliant.</p>

<p><strong>Resumen de los Distintos M√©todos</strong></p>

<table>
    <tr><th>HTTP Method</th><th>Idempotent</th><th>Safe</th></tr>
    <tr><td>OPTIONS    </td><td>yes       </td><td>yes</td></tr>
    <tr><td>GET        </td><td>yes       </td><td>yes</td></tr>
    <tr><td>HEAD       </td><td>yes       </td><td>yes</td></tr>
    <tr><td>PUT        </td><td>yes       </td><td>no </td></tr>
    <tr><td>POST       </td><td>no        </td><td>no </td></tr>
    <tr><td>DELETE     </td><td>yes       </td><td>no </td></tr>
    <tr><td>PATCH      </td><td>no        </td><td>no </td></tr>
</table>

<ul>
  <li>See <a href="https://stackoverflow.com/questions/28459418/rest-api-put-vs-patch-with-real-life-examples/39338329#39338329">So when is PATCH not idempotent, then?</a></li>
</ul>

<p>To illustrate an example of a server implementation of a non-idempotent PATCH, suppose there is a <code class="language-plaintext highlighter-rouge">/users</code> resource, and suppose that calling <code class="language-plaintext highlighter-rouge">GET /users</code> returns a list of users, currently:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="p">[{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nl">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"firstuser"</span><span class="p">,</span><span class="w"> </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"firstuser@example.org"</span><span class="w"> </span><span class="p">}]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>Rather than <code class="language-plaintext highlighter-rouge">PATCH</code>ing <code class="language-plaintext highlighter-rouge">/users/{id}</code>, suppose the server allows PATCHing <code class="language-plaintext highlighter-rouge">/users</code>. 
Let‚Äôs issue this <code class="language-plaintext highlighter-rouge">PATCH</code> request:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>PATCH /users
[{ "op": "add", "username": "newuser", "email": "newuser@example.org" }]
</pre></td></tr></tbody></table></code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">op</code> is <code class="language-plaintext highlighter-rouge">add</code>, so a new user is added to the list.
Our patch document instructs the server to <code class="language-plaintext highlighter-rouge">add</code> a new user called <code class="language-plaintext highlighter-rouge">newuser</code> to the list of <code class="language-plaintext highlighter-rouge">users</code>. 
After calling this the first time, <code class="language-plaintext highlighter-rouge">GET /users</code> would return:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="p">[{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nl">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"firstuser"</span><span class="p">,</span><span class="w"> </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"firstuser@example.org"</span><span class="w"> </span><span class="p">},</span><span class="w">
 </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nl">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"newuser"</span><span class="p">,</span><span class="w"> </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"newuser@example.org"</span><span class="w"> </span><span class="p">}]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>Now, if we issue the exact same <code class="language-plaintext highlighter-rouge">PATCH</code> request as above, what happens? (Let‚Äôs assume that the <code class="language-plaintext highlighter-rouge">/users</code> resource allows duplicate usernames.) 
The <code class="language-plaintext highlighter-rouge">op</code> is <code class="language-plaintext highlighter-rouge">add</code>, so a new user is added to the list, and a subsequent <code class="language-plaintext highlighter-rouge">GET /users</code> returns:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="p">[{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nl">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"firstuser"</span><span class="p">,</span><span class="w"> </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"firstuser@example.org"</span><span class="w"> </span><span class="p">},</span><span class="w">
 </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nl">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"newuser"</span><span class="p">,</span><span class="w"> </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"newuser@example.org"</span><span class="w"> </span><span class="p">},</span><span class="w">
 </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nl">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"newuser"</span><span class="p">,</span><span class="w"> </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"newuser@example.org"</span><span class="w"> </span><span class="p">}]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">/users</code> resource has changed again, even though we issued the exact same <code class="language-plaintext highlighter-rouge">PATCH</code> against the exact same endpoint. This particular <code class="language-plaintext highlighter-rouge">PATCH</code> is not idempotent.</p>

<p>Although <code class="language-plaintext highlighter-rouge">PATCH</code> isn‚Äôt guaranteed to be idempotent, there‚Äôs nothing in the <code class="language-plaintext highlighter-rouge">PATCH</code> specification to prevent you from making all <code class="language-plaintext highlighter-rouge">PATCH</code> operations on your 
particular server idempotent.</p>

<h3 id="status">STATUS</h3>

<ul>
  <li><a href="https://httpstatuses.com/204">204</a></li>
</ul>

<p><strong>204</strong>:</p>

<ul>
  <li>
    <p>The server has successfully fulfilled the request and <strong>that there is no additional content to send in the response payload body</strong>.</p>
  </li>
  <li>
    <p>A 204 response is terminated by the first empty line after the header fields <strong>because it cannot contain a message body</strong>.</p>
  </li>
  <li>
    <p>A 204 response is cacheable by default</p>
  </li>
</ul>

<p>Un experimento: si a√±adimos un <code class="language-plaintext highlighter-rouge">body</code> a una respuesta <code class="language-plaintext highlighter-rouge">204</code> en el c√≥digo de la pr√°ctica:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>[~/.../chapter20-nodejs/juanIrache-20_3_public_space(master)]$ git diff -U12 server.js
</pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="gh">diff --git a/20_3_public_space/server.js b/20_3_public_space/server.js
index 79d3f5d..3fa658a 100644
</span><span class="gd">--- a/20_3_public_space/server.js
</span><span class="gi">+++ b/20_3_public_space/server.js
</span><span class="p">@@ -83,25 +83,25 @@</span> const { createWriteStream } = require('fs');
 function pipeStream(from, to) {
   return new Promise((resolve, reject) =&gt; {
     from.on('error', reject);
     to.on('error', reject);
     to.on('finish', resolve);
     from.pipe(to);
   });
 }
 
 methods.PUT = async function(request) {
   let path = urlPath(request.url);
   await pipeStream(request, createWriteStream(path));
<span class="gd">-  return { status: 204 };
</span><span class="gi">+  return { status: 204, body: path };
</span> };
</pre></td></tr></tbody></table></code></pre></div></div>

<p>‚Ä¶ Y hacemos un request con  <code class="language-plaintext highlighter-rouge">PUT</code>, observamos que el status <code class="language-plaintext highlighter-rouge">204</code> hace que no llegue ning√∫n cuerpo al cliente:</p>

<table>
  <tr><th>Server</th><th>Client</th></tr>
  <tr>
    <td><xmp>
    $ nodemon server.js 
    [nodemon] 1.11.0
    [nodemon] to restart at any time, enter `rs`
    [nodemon] watching: *.*
    [nodemon] starting `node server.js`
    method= PUT url=/tutu.txt
    </xmp></td>
    <td><xmp>
    $ curl -X PUT -d "hello world!" localhost:8000/tutu.txt
    $ 
    </xmp></td>
  </tr>
  <tr>
  <td>The server returns a 204</td>
  <td>No body received</td>
  </tr>
</table>

<p>If now we change the code to return a status <code class="language-plaintext highlighter-rouge">200</code>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>[~/.../chapter20-nodejs/juanIrache-20_3_public_space(master)]$ git diff server.js
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="gh">diff --git a/20_3_public_space/server.js b/20_3_public_space/server.js
index 79d3f5d..66fa8b9 100644
</span><span class="gd">--- a/20_3_public_space/server.js
</span><span class="gi">+++ b/20_3_public_space/server.js
</span><span class="p">@@ -92,7 +92,7 @@</span> function pipeStream(from, to) {
 methods.PUT = async function(request) {
   let path = urlPath(request.url);
   await pipeStream(request, createWriteStream(path));
<span class="gd">-  return { status: 204 };
</span><span class="gi">+  return { status: 200, body: path };
</span> };
</pre></td></tr></tbody></table></code></pre></div></div>
<p>And execute the same request, we get the body (the <code class="language-plaintext highlighter-rouge">path</code> to the modified file):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>$ curl -X PUT -d "hello world!" localhost:8000/tutu.txt
/Users/casiano/local/src/javascript/eloquent-javascript-3/juanIrache-solutions/20_3_public_space/tutu.txt
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="gulp-a-tool-to-automate-and-enhance-your-workflow">Gulp: a tool to Automate and Enhance your Workflow</h3>

<ul>
  <li><a href="/tema1-introduccion/build-tools">Learning the Basics of Gulp</a></li>
</ul>

<h2 id="jam-stack"><a href="/tema3-web/jam">JAM Stack</a></h2>

<h3 id="jekyll">Jekyll</h3>

<p>Recuerda que GitHub provee un servicio de Hosting de p√°ginas est√°ticas (<a href="https://pages.github.com/">GitHub Pages</a>) que se sirven mediante Jekyll.</p>

<p>En las pr√°cticas que siguen, pr√°ctica a usar Jekyll desplegando el finrome en GitHub Pages.</p>

<p>For more details, see <a href="/tema3-web/jekyyl">section Jekyll</a></p>

<h3 id="jekyll-en-tu-m√°quina">Jekyll en tu m√°quina</h3>

<p>To run the blog in your machine you need a <code class="language-plaintext highlighter-rouge">Gemfile</code>:</p>

<ul>
  <li><a href="https://jekyllrb.com/tutorials/using-jekyll-with-bundler/">Using Jekyll with Bundler</a></li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>[~/.../p4-t2-networking-Omar97perez/docs(master)]$ bundle init
Writing new Gemfile to /Users/casiano/campus-virtual/1920/sytws1920/eval/p4-t2-networking/p4-t2-networking-Omar97perez/docs/Gemfile
[~/.../p4-t2-networking-Omar97perez/docs(master)]$ bundle exec jekyll serve
Configuration file: /Users/casiano/campus-virtual/1920/sytws1920/eval/p4-t2-networking/p4-t2-networking-Omar97perez/docs/_config.yml
            Source: /Users/casiano/campus-virtual/1920/sytws1920/eval/p4-t2-networking/p4-t2-networking-Omar97perez/docs
       Destination: /Users/casiano/campus-virtual/1920/sytws1920/eval/p4-t2-networking/p4-t2-networking-Omar97perez/docs/_site
 Incremental build: disabled. Enable with --incremental
      Generating... 
                    done in 0.303 seconds.
 Auto-regeneration: enabled for '/Users/casiano/campus-virtual/1920/sytws1920/eval/p4-t2-networking/p4-t2-networking-Omar97perez/docs'
    Server address: http://127.0.0.1:4000/p3-t1-c3-http-p2-t1-c3-filesystem-omarperezznakar/
  Server running... press ctrl-c to stop.
</pre></td></tr></tbody></table></code></pre></div></div>
<p>The reason the server is listening at that address is because the value
given to <code class="language-plaintext highlighter-rouge">baseurl</code>
in the configuration file <code class="language-plaintext highlighter-rouge">_config.yml</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>[~/.../p4-t2-networking-Omar97perez/docs(master)]$ cat _config.yml 
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="c1"># Site settings</span>
<span class="na">title</span><span class="pi">:</span> <span class="s">Pr√°ctica </span><span class="m">4</span>
<span class="na">email</span><span class="pi">:</span> <span class="s">alu0100945645@ull.edu.es</span>
<span class="na">description</span><span class="pi">:</span> <span class="pi">&gt;</span> <span class="c1"># this means to ignore newlines until "baseurl:"</span>
  <span class="s">Write an awesome description for your new site here. You can edit this</span>
  <span class="s">line in _config.yml. It will appear in your document head meta (for</span>
  <span class="s">Google search results) and in your feed.xml site description.</span>
<span class="na">baseurl</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/p3-t1-c3-http-p2-t1-c3-filesystem-omarperezznakar"</span> <span class="c1"># the subpath of your site, e.g. /blog/</span>
<span class="na">url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">http://jekyll.github.io"</span> <span class="c1"># the base hostname &amp; protocol for your site</span>
<span class="na">twitter_username</span><span class="pi">:</span> <span class="s">jekyllrb</span>
<span class="na">github_username</span><span class="pi">:</span>  <span class="s">jekyll</span>
<span class="na">author</span><span class="pi">:</span> <span class="s">Omar Patricio P√©rez Znakar</span>

<span class="c1"># Build settings</span>
<span class="na">markdown</span><span class="pi">:</span> <span class="s">kramdown</span>
<span class="na">permalink</span><span class="pi">:</span> <span class="s">/:year/:title:output_ext</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/images/omar-blog.png" alt="Omar blog" /></p>

<h3 id="gastby"><a href="gatsby">Gastby</a></h3>

<p>Gatsby is a React-based, GraphQL powered, static site generator.</p>

<h2 id="chapter-3-networking-with-sockets">Chapter 3: Networking with Sockets</h2>

<ul>
  <li><a href="/tema2-async/sockets">Apuntes del tema Sockets</a></li>
  <li><a href="https://github.com/ULL-MII-SYTWS-2021/books-shared">Material suplementario</a></li>
  <li><a href="/tema2-async/practicas/p4-t2-networking/">Descripci√≥n de la pr√°ctica tema2-async/practicas/p4-t2-networking/</a></li>
  <li><a href="/tema4-devops/github-actions">GitHub Actions</a></li>
  <li>
    <p><a href="https://github.com/ULL-MII-SYTWS-2021/p4-t2-networking-crguezl">Repo de ejemplo con una soluci√≥n y GitHub Actions p4-t2-networking-crguezl</a></p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>  [~/.../github-actions-learning/p4-t2-net-github-actions-crguezl(master)]$ pwd -P
  /Users/casiano/local/src/github-actions-learning/p4-t2-net-github-actions-crguezl
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ul>

<h3 id="la-librer√≠a-libldj-clientjs">La Librer√≠a: lib/ldj-client.js</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>[~/.../p4-t2-networking/networking-with-sockets-chapter-3-crguezl(master)]$ cat lib/ldj-client.js 
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="p">{</span> <span class="nx">EventEmitter</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">events</span><span class="dl">"</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">net</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">net</span><span class="dl">"</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">EOM</span> <span class="o">=</span> <span class="dl">"</span><span class="se">\n</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">class</span> <span class="nx">LDJClient</span> <span class="kd">extends</span> <span class="nx">EventEmitter</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">();</span>
    <span class="kd">let</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="dl">""</span><span class="p">;</span>

    <span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">data</span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">buffer</span> <span class="o">+=</span> <span class="nx">data</span><span class="p">;</span>
        <span class="kd">let</span> <span class="nx">boundary</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">EOM</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">boundary</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">boundary</span><span class="p">);</span>
          <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">boundary</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">input</span><span class="p">));</span>
          <span class="nx">boundary</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">EOM</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">remaining buffer = </span><span class="dl">"</span><span class="o">+</span><span class="nx">buffer</span><span class="p">)</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">close</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">input</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Not a JSON message </span><span class="dl">'</span><span class="o">+</span><span class="nx">e</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> 
      <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">close</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="cm">/*
  A static method is attached to the LDJClient class rather than
  to individual instances.
  */</span>
  <span class="kd">static</span> <span class="nx">connect</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/*
    The connect method is a convenience
    for consumers so that they don't have to use new LDJClient to
    create a new instance of LDJClient
    */</span>
    <span class="kd">let</span> <span class="nx">stream</span> <span class="o">=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">connect</span><span class="p">(...</span><span class="nx">args</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">LDJClient</span><span class="p">(</span><span class="nx">stream</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">LDJClient</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>
    <p><a href="https://nodejs.org/api/net.html#net_net_createconnection_options_connectlistener"><code class="language-plaintext highlighter-rouge">net.createConnection(options[, connectListener])</code></a> (<code class="language-plaintext highlighter-rouge">net.connect</code> es un sin√≥nimo de <code class="language-plaintext highlighter-rouge">net.createConnection</code>)</p>
  </li>
  <li>
    <p>Algunos m√©todos de los objetos de la clase <a href="https://nodejs.org/api/events.html#events_class_eventemitter">EventEmitter</a>:</p>
  </li>
</ul>

<p><img src="/assets/images/event-emitter-methods.png" alt="" /></p>

<h3 id="el-cliente">El cliente</h3>

<p>El c√≥digo del cliente:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>$ cat net-watcher-ldj-client.js 
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">ins</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">lib/ins.js</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./port.js</span><span class="dl">"</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">LDJClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">lib/ldj-client.js</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">ldjClient</span> <span class="o">=</span> <span class="nx">LDJClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">({</span><span class="na">port</span><span class="p">:</span> <span class="nx">PORT</span><span class="p">});</span>

<span class="nx">ldjClient</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">,</span> <span class="nx">message</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">received data: </span><span class="dl">"</span><span class="o">+</span>  <span class="nx">ins</span><span class="p">(</span><span class="nx">message</span><span class="p">));</span>
<span class="p">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>El m√≥dulo auxiliar:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>[~/.../p4-t2-networking/networking-with-sockets-chapter-3-crguezl(master)]$ cat lib/ins.js 
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">inspect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">util</span><span class="dl">"</span><span class="p">).</span><span class="nx">inspect</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">inspect</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="p">{</span><span class="na">depth</span><span class="p">:</span> <span class="kc">Infinity</span><span class="p">,</span> <span class="na">colors</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>[~/.../p4-t2-networking/networking-with-sockets-chapter-3-crguezl(master)]$ cat port.js 
module.exports = 60300;
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="servidor">Servidor</h3>

<p>Vamos a construir una clase <code class="language-plaintext highlighter-rouge">lib/ldj-server.js</code> para  que los sockets sepan enviar 
mensajes de acuerdo con el protocolo LDJ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>[~/.../p4-t2-networking/networking-with-sockets-chapter-3-crguezl(master)]$ cat lib/ldj-server.js 
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">net</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">net</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">EOM</span> <span class="o">=</span> <span class="dl">"</span><span class="se">\n</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">class</span> <span class="nx">LDJServer</span> <span class="kd">extends</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Server</span> <span class="p">{</span>

  <span class="kd">static</span> <span class="nx">toLDJSocket</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span> <span class="o">=</span> <span class="nx">message</span> <span class="o">=&gt;</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span><span class="o">+</span><span class="nx">EOM</span><span class="p">);</span>
  <span class="p">}</span> 

  <span class="kd">static</span> <span class="nx">createServer</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">connectionListener</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">net</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(...</span><span class="nx">args</span><span class="p">,</span> <span class="nx">socket</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">toLDJSocket</span><span class="p">(</span><span class="nx">socket</span><span class="p">);</span> 
      <span class="k">return</span> <span class="nx">connectionListener</span><span class="p">(</span><span class="nx">socket</span><span class="p">);</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">LDJServer</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Lo que hacemos en la clase <code class="language-plaintext highlighter-rouge">LDJServer</code> as modificar <code class="language-plaintext highlighter-rouge">createServer</code>para que el objeto <code class="language-plaintext highlighter-rouge">Socket</code> disponga de un m√©todo <code class="language-plaintext highlighter-rouge">send</code> que 
env√≠a un mensaje siguiendo el protocolo <code class="language-plaintext highlighter-rouge">LDJ</code>.</p>

<p>Ahora el c√≥digo del servidor queda as√≠:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>[~/.../p4-t2-networking/networking-with-sockets-chapter-3-crguezl(master)]$ cat net-watcher-json-service.js
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./port.js</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">LDJServer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">./lib/ldj-server.js</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">fs</span><span class="dl">"</span><span class="p">);</span>

<span class="nx">LDJServer</span><span class="p">.</span><span class="nx">toLDJSocket</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">fileName</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">.</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// Only one watcher, not a watcher per client as in the book</span>
<span class="kd">const</span> <span class="nx">watcher</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="nx">fileName</span><span class="p">,</span> <span class="p">{</span> <span class="na">recursive</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span> 

<span class="nx">LDJServer</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">connection</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Subscriber connected</span><span class="dl">'</span><span class="p">);</span>

  <span class="nx">connection</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">watching</span><span class="dl">"</span><span class="p">,</span> <span class="na">target</span><span class="p">:</span> <span class="nx">fileName</span><span class="p">});</span>
  <span class="nx">watcher</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">change</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">eventType</span><span class="p">,</span> <span class="nx">filename</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nx">eventType</span><span class="p">,</span> <span class="na">timestamp</span><span class="p">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span> <span class="na">target</span><span class="p">:</span> <span class="nx">filename</span> <span class="p">};</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
      <span class="nx">connection</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="nx">connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">close</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Subscriber disconnected</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">listening on port </span><span class="dl">"</span><span class="o">+</span><span class="nx">PORT</span><span class="p">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="running-server-and-client">Running Server and Client</h3>

<table>
  <tr><th>Server</th><th>Client</th></tr>
  <tr>
    <td><xmp>
$ node net-watcher-json-service.js
listening on port 60300
Subscriber connected
{"type":"change","timestamp":1574757343821,"target":"target.txt"}
    </xmp></td>
    <td><xmp>
$ node net-watcher-ldj-client.js 
received data: { type: 'watching', target: '.' }
received data: { type: 'change', timestamp: 1574757343821, target: 'target.txt' }
    </xmp></td>
  </tr>
  <tr>
  <td>Salida para el comando </td>
  <td>touch target.txt</td>
  </tr>
</table>

<h2 id="the-observer-pattern">The Observer Pattern</h2>

<blockquote>
  <p>The <strong>observer pattern</strong> is a software design pattern in which an object, called the <strong>subject</strong>, maintains a list of its dependents, called <strong>observers</strong>, and notifies them automatically of any state changes, usually by calling one of their methods.</p>
</blockquote>

<p><img src="/assets/images/observer-design-pattern.png" alt="" /></p>

<p>See also</p>

<ul>
  <li><a href="https://addyosmani.com/resources/essentialjsdesignpatterns/book/#observerpatternjavascript">Learning JavaScript Design Patterns. A book by Addy Osmani</a></li>
</ul>

<h2 id="resources-and-references-for-this-lesson">Resources and References for this Lesson</h2>

<ul>
  <li><a href="https://code.tutsplus.com/tutorials/real-time-chat-with-nodejs-readline-socketio--cms-20953">Real-Time Chat With Node.js‚Äô Readline &amp; Socket.io</a></li>
  <li>Para leer: <a href="https://www.freecodecamp.org/news/how-to-code-your-own-event-emitter-in-node-js-a-step-by-step-guide-e13b7e7908e1/">How to code your own event emitter in Node.js: a step-by-step guide</a> por Rajesh Pillai</li>
  <li><a href="/clases/2019-11-25/">This class in GitHub pages</a></li>
  <li><a href="https://github.com/ULL-MII-SYTWS-2021/eloquent-javascript-exercises">See this repo with the solutions by Juan Irache to EJS exercises</a>
    <ul>
      <li><a href="https://github.com/ULL-MII-SYTWS-2021/eloquent-javascript-exercises/tree/master/20_3_public_space">20_3_a_public_space</a></li>
    </ul>
  </li>
  <li>See section <a href="https://eloquentjavascript.net/20_node.html#the-http-module">of the EJS book: The HTTP module</a></li>
  <li><a href="https://nodejs.org/es/docs/guides/anatomy-of-an-http-transaction/">Node.js docs: Anatomy of an HTTP Transaction</a></li>
</ul>

            </div>
                        <details>
                <summary><h2>Comment with GitHub Utterances</h2></summary>
                <script src="https://utteranc.es/client.js"
        repo="ULL-MII-SYTWS-1920/ull-mii-sytws-1920.github.io"
        issue-term="pathname"
        label="SYTWS"
        theme="dark-blue"
        crossorigin="anonymous"
        async>
</script>
            </details>
            
            <details>
                <summary>
                   <h2>Comment with Disqus</h2> 
                </summary>              
                



<div id="disqus_thread">
    thread de discusion
</div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: 
EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: 
       https://disqus.com/admin/universalcode/#configuration-variables*/

/*
var disqus_config = function () {
   this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
   this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/

(function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://https-ull-mii-sytws-1920-github-io.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
   (d.head || d.body).appendChild(s);
})();

</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            

 

            </details>
        </section>
    
    </div>


    
</body>

</html>
